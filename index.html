<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca de Scripts CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #1d4ed8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #1e40af; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #fbbF24; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
        .script-content { white-space: pre-wrap; word-wrap: break-word; }
        .nav-button.active { background-color: #1d4ed8; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark .nav-button.active { background-color: #fbbF24; color: #111827; }
        #add-script-modal, #delete-confirm-modal, #login-modal { transition: opacity 0.3s ease; }
        
        /* Reglas de visibilidad para Admin */
        .admin-only-flex { display: none !important; }
        body.admin-mode .admin-only-flex { display: flex !important; }

        /* Estilo para el bot√≥n de copiar confirmado */
        .copy-btn.copied {
            background-color: #16a34a !important; /* Verde brillante (Tailwind green-600) */
            color: white !important;
        }
        .copy-btn.copied:hover {
            background-color: #15803d !important; /* Tono m√°s oscuro al pasar el mouse (green-700) */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 transition-colors duration-300">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="relative text-center mb-8">
            <img src="logoafore.png" alt="Logo Afore Coppel" class="h-12 mx-auto mb-4">
            <h1 class="text-4xl sm:text-5xl font-bold text-blue-800 dark:text-yellow-400">Biblioteca de Scripts</h1>
            <p class="text-lg text-gray-500 dark:text-gray-400 mt-2">Soluciones r√°pidas para casos de CRM en Salesforce</p>
            <div class="absolute top-0 right-0 flex items-center gap-4">
                <div id="auth-controls"></div>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                    <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </header>

        <div class="mb-8 max-w-2xl mx-auto">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <input type="text" id="search-input" class="block w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-full py-3 pl-10 pr-4 text-gray-900 dark:text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-yellow-500 transition" placeholder="Buscar por t√≠tulo o descripci√≥n...">
            </div>
        </div>

        <nav id="category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
            <button data-category="all" class="nav-button active font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Todos</button>
            <button data-category="favorites" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">‚òÖ Favoritos</button>
            <button data-category="popular" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">üî• Populares</button>
            <button data-category="unificacion" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Unificaci√≥n/Separaci√≥n</button>
            <button data-category="exp" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Exp. y Serv.</button>
            <button data-category="parciales" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Retiros Parciales</button>
            <button data-category="totales" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Retiros Totales</button>
            <button data-category="extras" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Extras</button>
        </nav>

        <main id="scripts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
        
        <div id="loading-indicator" class="text-center py-10"><p class="text-gray-500 dark:text-gray-400">Cargando scripts desde la nube...</p></div>
    </div>

    <footer class="text-center py-8 border-t border-gray-200 dark:border-gray-700">
        <p class="text-sm text-gray-500 dark:text-gray-400">
            Herramienta creada por la Gerencia de Atenci√≥n al P√∫blico - Afore Coppel
        </p>
    </footer>

    <button id="add-script-btn" class="admin-only-flex fixed bottom-8 right-8 bg-blue-700 dark:bg-yellow-400 text-white dark:text-blue-900 w-16 h-16 rounded-full shadow-lg items-center justify-center text-3xl font-bold transform hover:scale-110 transition-transform">+</button>

    <div id="add-script-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-blue-800 dark:text-yellow-400">Agregar Nuevo Script</h2>
            <form id="script-form">
                <input type="hidden" id="script-id">
                <div class="space-y-4">
                    <input type="text" id="script-title" placeholder="T√≠tulo del Script" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="script-description" placeholder="Descripci√≥n breve" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="2"></textarea>
                    <textarea id="script-text" placeholder="Texto completo del script..." required class="w-full p-2 border rounded font-mono dark:bg-gray-700 dark:border-gray-600" rows="6"></textarea>
                    <select id="script-category" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- Seleccionar Categor√≠a --</option>
                        <option value="unificacion">Unificaci√≥n/Separaci√≥n</option>
                        <option value="exp">Exp. y Serv.</option>
                        <option value="parciales">Retiros Parciales</option>
                        <option value="totales">Retiros Totales</option>
                        <option value="extras">Extras</option>
                    </select>
                    <input type="text" id="script-variables" placeholder="Variables (separadas por coma, ej: FECHA, MONTO)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-btn" class="py-2 px-4 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Guardar Script</button>
                </div>
            </form>
             <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>
    
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 class="text-xl font-bold mb-4">¬øEst√°s seguro?</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="py-2 px-6 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">No</button>
                <button id="confirm-delete-btn" class="py-2 px-6 rounded bg-red-600 text-white hover:bg-red-700">S√≠, Eliminar</button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h2 class="text-2xl font-bold mb-4 text-center text-blue-800 dark:text-yellow-400">Acceso Admin</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Correo electr√≥nico" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <input type="password" id="login-password" placeholder="Contrase√±a" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Iniciar Sesi√≥n</button>
                </div>
            </form>
            <button id="close-login-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyAvq0CF94lVwGZAtXiFZKHwS5q4ZA489lM",
          authDomain: "scripts-une-gap.firebaseapp.com",
          projectId: "scripts-une-gap",
          storageBucket: "scripts-une-gap.firebasestorage.app",
          messagingSenderId: "567975326387",
          appId: "1:567975326387:web:28edbab67668d1a829f6c6",
          measurementId: "G-GJK53TR2D6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const scriptsCollection = collection(db, 'scripts');

        let allScripts = [];
        const container = document.getElementById('scripts-container');
        const filters = document.getElementById('category-filters');
        const searchInput = document.getElementById('search-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        let favorites = JSON.parse(localStorage.getItem('favoriteScripts')) || [];
        const authControls = document.getElementById('auth-controls');
        const copiedScripts = new Set();

        // --- FUNCI√ìN PARA MOSTRAR LAS TARJETAS (RENDER) ---
        const renderScripts = (scriptsToRender) => {
            container.innerHTML = '';
            if (scriptsToRender.length === 0 && loadingIndicator.style.display === 'none') {
                container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No se encontraron resultados.</p>`;
                return;
            }

            const activeCategory = filters.querySelector('.active').dataset.category;
            const isPopularView = activeCategory === 'popular';
            
            scriptsToRender.forEach(script => {
                const isFavorite = favorites.includes(script.id);
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 ease-in-out flex flex-col';
                
                let variablesHtml = '';
                if (script.variables && script.variables.length > 0) {
                    const variableInputs = script.variables.map(v => `
                        <div class="flex items-center gap-2">
                            <label for="var-${script.id}-${v}" class="text-sm font-mono text-gray-600 dark:text-gray-300 w-1/3 truncate" title="${v}">${v}:</label>
                            <input type="text" id="var-${script.id}-${v}" data-variable-name="${v}" class="variable-input w-2/3 p-1 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm focus:ring-1 focus:ring-blue-500 dark:focus:ring-yellow-500 outline-none" placeholder="Valor para ${v}">
                        </div>
                    `).join('');
                    variablesHtml = `<div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-3"><h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">Reemplazar Variables:</h4><div class="space-y-2">${variableInputs}</div></div>`;
                }

                let popularBadgeHtml = '';
                if (isPopularView) {
                    const usageCount = script.copyCount || 0;
                    popularBadgeHtml = `<div class="absolute top-3 right-20 flex items-center gap-1 text-xs bg-red-100 text-red-800 dark:bg-orange-900 dark:text-orange-300 px-2 py-1 rounded-full font-semibold">üî•<span>${usageCount}</span></div>`;
                }
                
                let adminOptionsHtml = `
                        <div class="admin-only-flex absolute top-2 right-10 z-10">
                             <button class="options-btn p-1 text-gray-400 hover:text-blue-700 dark:hover:text-yellow-400">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>
                             </button>
                             <div class="options-menu absolute right-0 mt-8 w-40 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 hidden">
                                 <a href="#" class="edit-btn block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Modificar</a>
                                 <a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/50">Eliminar</a>
                             </div>
                        </div>`;

                card.innerHTML = `
                        ${adminOptionsHtml}
                        ${popularBadgeHtml}
                        <div class="p-6 flex-grow">
                            <div class="flex justify-between items-start">
                                <h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2 pr-20">${script.title}</h2>
                                <button class="favorite-btn absolute top-2 right-2 p-1 text-gray-400 hover:text-yellow-500 transition-colors" data-id="${script.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="pointer-events-none transition-colors duration-200 ${isFavorite ? 'text-yellow-400' : 'text-gray-400/60 hover:text-yellow-400'}" viewBox="0 0 16 16">
                                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                    </svg>
                                </button>
                            </div>
                            <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${script.description}</p>
                            <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm text-gray-700 dark:text-gray-200 max-h-48 overflow-y-auto">
                                <pre class="script-content font-sans">${script.scriptText}</pre>
                            </div>
                            ${variablesHtml}
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                            <button class="copy-btn w-full bg-yellow-400 text-blue-800 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ease-in-out hover:bg-yellow-500 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                                 <span>Copiar Script</span>
                            </button>
                        </div>
                `;
                card.dataset.id = script.id;
                container.appendChild(card);

                // Revisa si el script reci√©n renderizado debe estar en estado "copiado"
                if (copiedScripts.has(script.id)) {
                    const copyBtn = card.querySelector('.copy-btn');
                    if (copyBtn) {
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>
                            <span>¬°Copiado!</span>`;
                        copyBtn.classList.add('copied');
                    }
                }
            });
        };
        
        // --- FUNCI√ìN CENTRAL PARA APLICAR FILTROS Y B√öSQUEDA ---
        const applyFilters = () => {
             const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = filters.querySelector('.active').dataset.category;
            let filteredScripts = allScripts;
            if (activeCategory === 'favorites') {
                filteredScripts = allScripts.filter(script => favorites.includes(script.id));
            } else if (activeCategory === 'popular') {
                filteredScripts = [...allScripts].sort((a, b) => (b.copyCount || 0) - (a.copyCount || 0));
            } else if (activeCategory !== 'all') {
                filteredScripts = allScripts.filter(script => script.category === activeCategory);
            }
            if (searchTerm) {
                filteredScripts = filteredScripts.filter(s => s.title.toLowerCase().includes(searchTerm) || s.description.toLowerCase().includes(searchTerm));
            }
            renderScripts(filteredScripts);
        };

        // --- MANEJO DE AUTENTICACI√ìN Y DATOS ---
        onAuthStateChanged(auth, user => {
            if (user) {
                document.body.classList.add('admin-mode');
                authControls.innerHTML = `<button id="logout-btn" class="text-sm text-gray-500 hover:text-blue-700 dark:hover:text-yellow-400">Salir</button>`;
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            } else {
                document.body.classList.remove('admin-mode');
                authControls.innerHTML = `<button id="login-btn" title="Acceso Admin" class="p-1 rounded-full text-blue-600 dark:text-yellow-400 hover:text-blue-800 dark:hover:text-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16"><path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.056.255.098.386.123.134.026.275.042.415.042.14 0 .281-.016.415-.042.131-.025.266-.067.386-.123.241-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.018 7.018 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.016 7.016 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/><path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.965a.5.5 0 1 1-.966.19l-.385-1.965a1.5 1.5 0 1 1 1.966-1.606z"/></svg></button>`;
                document.getElementById('login-btn').addEventListener('click', openLoginModal);
            }
            applyFilters();
        });

        onSnapshot(scriptsCollection, (snapshot) => {
            allScripts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            loadingIndicator.style.display = 'none';
            applyFilters();
        }, (error) => {
             console.error("Error al obtener los datos de Firebase: ", error);
             loadingIndicator.innerHTML = '<p class="text-red-500">Error de conexi√≥n con la base de datos.</p>';
        });

        // --- L√ìGICA DE EVENTOS DE UI ---
        container.addEventListener('click', function(e) {
            const copyButton = e.target.closest('.copy-btn');
            const favButton = e.target.closest('.favorite-btn');
            const optionsButton = e.target.closest('.options-btn');
            const editButton = e.target.closest('.edit-btn');
            const deleteButton = e.target.closest('.delete-btn');

            if (copyButton) {
                const card = copyButton.closest('.relative');
                const scriptId = card.dataset.id;
                
                if (copiedScripts.has(scriptId)) return;

                let scriptTextToCopy = card.querySelector('.script-content').textContent;
                const variableInputs = card.querySelectorAll('.variable-input');

                if (variableInputs.length > 0) {
                    variableInputs.forEach(input => {
                        const varName = input.dataset.variableName;
                        const varValue = input.value || `[${varName}]`; // Si est√° vac√≠o, mantiene el placeholder
                        const regex = new RegExp(varName, 'g');
                        scriptTextToCopy = scriptTextToCopy.replace(regex, varValue);
                    });
                }
                
                const textArea = document.createElement("textarea");
                textArea.value = scriptTextToCopy;
                textArea.style.position = "fixed";
                textArea.style.top = "0";
                textArea.style.left = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);

                const scriptRef = doc(db, 'scripts', scriptId);
                updateDoc(scriptRef, { copyCount: increment(1) }).catch(error => {
                    console.warn("No se pudo actualizar el contador de copias.", error.message);
                });

                copiedScripts.add(scriptId);
                applyFilters();

                setTimeout(() => {
                    copiedScripts.delete(scriptId);
                    applyFilters();
                }, 2000);
            }


            if (favButton) {
                const scriptId = favButton.dataset.id;
                const starIcon = favButton.querySelector('svg');
                if (favorites.includes(scriptId)) {
                    favorites = favorites.filter(id => id !== scriptId);
                    starIcon.classList.remove('text-yellow-400');
                    starIcon.classList.add('text-gray-400/60');
                } else {
                    favorites.push(scriptId);
                    starIcon.classList.add('text-yellow-400');
                    starIcon.classList.remove('text-gray-400/60');
                }
                localStorage.setItem('favoriteScripts', JSON.stringify(favorites));
                if (filters.querySelector('.active').dataset.category === 'favorites') applyFilters();
            }
            
            if (optionsButton) {
                document.querySelectorAll('.options-menu').forEach(m => {
                    if (m !== optionsButton.nextElementSibling) m.classList.add('hidden');
                });
                optionsButton.nextElementSibling.classList.toggle('hidden');
            }
            if (editButton) {
                const scriptId = e.target.closest('[data-id]').dataset.id;
                openEditModal(scriptId);
            }
            if (deleteButton) {
                const scriptId = e.target.closest('[data-id]').dataset.id;
                openDeleteModal(scriptId);
            }
        });

        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.options-btn')) {
                document.querySelectorAll('.options-menu').forEach(m => m.classList.add('hidden'));
            }
        });
        
        filters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                filters.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                applyFilters();
            }
        });
        searchInput.addEventListener('input', applyFilters);

        // --- L√ìGICA MODALES ---
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const closeLoginModalBtn = document.getElementById('close-login-modal-btn');
        const loginError = document.getElementById('login-error');
        
        const openLoginModal = () => { loginModal.classList.remove('hidden'); setTimeout(() => loginModal.classList.remove('opacity-0'), 10); };
        const closeLoginModal = () => { loginModal.classList.add('opacity-0'); setTimeout(() => { loginModal.classList.add('hidden'); loginForm.reset(); loginError.classList.add('hidden'); }, 300); };
        
        closeLoginModalBtn.addEventListener('click', closeLoginModal);
        loginModal.addEventListener('click', (e) => { if (e.target === loginModal) closeLoginModal(); });
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => closeLoginModal())
                .catch(error => { loginError.textContent = 'Credenciales incorrectas.'; loginError.classList.remove('hidden'); });
        });
        
        const modal = document.getElementById('add-script-modal');
        const addScriptBtn = document.getElementById('add-script-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const form = document.getElementById('script-form');
        const modalTitle = document.getElementById('modal-title');
        const scriptIdInput = document.getElementById('script-id');

        const openModal = (title = "Agregar Nuevo Script") => { modalTitle.textContent = title; modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); };
        const closeModal = () => { modal.classList.add('opacity-0'); setTimeout(() => { modal.classList.add('hidden'); form.reset(); scriptIdInput.value = ''; }, 300); };
        
        addScriptBtn.addEventListener('click', () => openModal());
        cancelBtn.addEventListener('click', closeModal);
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        const openEditModal = (id) => {
            const scriptToEdit = allScripts.find(s => s.id === id);
            if (!scriptToEdit) return;
            scriptIdInput.value = id;
            document.getElementById('script-title').value = scriptToEdit.title;
            document.getElementById('script-description').value = scriptToEdit.description;
            document.getElementById('script-text').value = scriptToEdit.scriptText;
            document.getElementById('script-category').value = scriptToEdit.category;
            document.getElementById('script-variables').value = (scriptToEdit.variables || []).join(', ');
            openModal("Modificar Script");
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const scriptId = scriptIdInput.value;
            const scriptData = {
                title: document.getElementById('script-title').value,
                description: document.getElementById('script-description').value,
                scriptText: document.getElementById('script-text').value,
                category: document.getElementById('script-category').value,
                variables: document.getElementById('script-variables').value.split(',').map(v => v.trim()).filter(v => v)
            };
            try {
                if (scriptId) { 
                    const scriptRef = doc(db, 'scripts', scriptId);
                    await updateDoc(scriptRef, scriptData); 
                } 
                else { 
                    scriptData.copyCount = 0; // Iniciar contador para nuevos scripts
                    await addDoc(scriptsCollection, scriptData); 
                }
                closeModal();
            } catch (error) { console.error("Error al guardar: ", error); alert("Hubo un error al guardar el script."); }
        });

        const deleteModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        let scriptToDeleteId = null;

        const openDeleteModal = (id) => { scriptToDeleteId = id; deleteModal.classList.remove('hidden'); setTimeout(() => deleteModal.classList.remove('opacity-0'), 10); };
        const closeDeleteModal = () => { deleteModal.classList.add('opacity-0'); setTimeout(() => { deleteModal.classList.add('hidden'); scriptToDeleteId = null; }, 300); };
        
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeDeleteModal(); });
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!scriptToDeleteId) return;
            try {
                await deleteDoc(doc(db, 'scripts', scriptToDeleteId));
                closeDeleteModal();
            } catch (error) { console.error("Error al eliminar: ", error); alert("Hubo un error al eliminar el script."); }
        });
        
        const themeToggle = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            lightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            darkIcon.classList.remove('hidden');
        }
        themeToggle.addEventListener('click', () => {
            darkIcon.classList.toggle('hidden');
            lightIcon.classList.toggle('hidden');
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

    </script>
</body>
</html>



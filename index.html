<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca de Scripts CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #1d4ed8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #1e40af; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #fbbF24; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
        .script-content { white-space: pre-wrap; word-wrap: break-word; }
        .nav-button.active { background-color: #1d4ed8; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark .nav-button.active { background-color: #fbbF24; color: #111827; }
        
        /* Transiciones */
        #add-item-modal, #delete-confirm-modal, #login-modal, #register-modal, #info-modal { transition: opacity 0.3s ease; }
        .admin-only-flex { display: none !important; }
        body.admin-mode .admin-only-flex { display: flex !important; }

        /* BotÃ³n copiado */
        .copy-btn.copied { background-color: #16a34a !important; color: white !important; }
        .copy-btn.copied:hover { background-color: #15803d !important; }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .card-enter { animation: fadeIn 0.5s ease-out forwards; }
        
        /* NavegaciÃ³n */
        .main-nav-btn { transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .main-nav-btn.active { background-color: #1d4ed8; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .dark .main-nav-btn.active { background-color: #fbbF24; color: #111827; }
        
        /* Code Pills (Aprende SQL) */
        .code-pill { background-color: #dbeafe; color: #1e40af; font-family: monospace; border-radius: 0.375rem; padding: 0.125rem 0.5rem; font-size: 0.875rem; font-weight: 600; }
        .dark .code-pill { background-color: #374151; color: #93c5fd; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 transition-colors duration-300">

    <div id="gatekeeper" class="fixed inset-0 z-50 bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-4 transition-opacity duration-500">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 text-center border border-gray-200 dark:border-gray-700">
            <img src="logoafore.png" alt="Logo" class="h-16 mx-auto mb-6" onerror="this.style.display='none'">
            <h1 class="text-3xl font-bold text-blue-900 dark:text-yellow-400 mb-2">Biblioteca GAP</h1>
            <p class="text-gray-600 dark:text-gray-300 mb-8">Acceso exclusivo para colaboradores autorizados.</p>
            
            <div id="gatekeeper-actions" class="space-y-4">
                <button id="btn-landing-login" class="w-full py-3 px-4 bg-blue-700 hover:bg-blue-800 text-white font-bold rounded-lg shadow transition-colors">Iniciar SesiÃ³n</button>
                <button id="btn-landing-register" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow transition-colors">Solicitar Acceso</button>
            </div>
            <div id="gatekeeper-loading" class="hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-700 dark:border-yellow-400 mx-auto"></div>
                <p class="mt-4 text-sm text-gray-500">Verificando credenciales...</p>
            </div>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden opacity-0 transition-opacity duration-500">
        
        <div class="flex justify-between items-center py-4 px-2 mb-6">
            <div class="flex items-center gap-4">
                <img src="logoafore.png" alt="Logo Afore Coppel" class="h-14" onerror="this.alt='Logo Afore Coppel'; this.style.display='none';">
                <div class="border-l border-gray-300 dark:border-gray-600 h-14"></div>
                <img src="logogap.png" alt="Logo Gerencia" class="w-24" onerror="this.alt='Logo Gerencia'; this.style.display='none';">
            </div>
            <div class="flex items-center gap-4">
                <div id="auth-controls" class="flex items-center gap-3"></div>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none transition-colors">
                    <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>

        <div id="main-nav" class="flex flex-wrap justify-center gap-4 mb-8">
            <button data-view="scripts" class="main-nav-btn active flex items-center gap-2 font-medium py-3 px-6 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Scripts</button>
            <button data-view="querys" class="main-nav-btn flex items-center gap-2 font-medium py-3 px-6 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Querys</button>
        </div>

        <div id="scripts-page-container">
            <header class="relative text-center mb-8 bg-cover bg-center rounded-lg shadow-lg overflow-hidden py-40" style="background-image: url('cafe.png'); background-color: #2c3e50;">
                <div class="absolute inset-0 bg-blue-900 bg-opacity-50"></div>
                <div class="relative z-10">
                    <h1 class="text-4xl sm:text-5xl font-bold text-white dark:text-yellow-300">Biblioteca de Scripts</h1>
                    <p class="text-lg text-gray-200 dark:text-gray-300 mt-2">Soluciones rÃ¡pidas para casos de CRM en Salesforce</p>
                </div>
            </header>

            <div class="mb-8 max-w-2xl mx-auto relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                <input type="text" id="search-input" class="block w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-full py-3 pl-10 pr-4 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar por tÃ­tulo o descripciÃ³n...">
            </div>

            <nav id="category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button data-category="all" class="nav-button active font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Todos</button>
                <button data-category="requests" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all admin-only-flex items-center gap-2">Solicitudes <span id="requests-count-badge" class="hidden bg-red-500 text-white text-xs w-5 h-5 rounded-full items-center justify-center">0</span></button>
                <button data-category="favorites" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">â˜… Favoritos</button>
                <button data-category="popular" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">ðŸ”¥ Populares</button>
                <button data-category="unificacion" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">UnificaciÃ³n/SeparaciÃ³n</button>
                <button data-category="exp" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Exp. y Serv.</button>
                <button data-category="parciales" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Retiros Parciales</button>
                <button data-category="totales" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Retiros Totales</button>
                <button data-category="extras" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Extras</button>
            </nav>
            
            <main id="scripts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
        </div>

        <div id="querys-page-container" class="hidden">
            <header class="relative text-center mb-8 bg-cover bg-center rounded-lg shadow-lg overflow-hidden py-40" style="background-image: url('cafe.png'); background-color: #2c3e50;">
                <div class="absolute inset-0 bg-blue-900 bg-opacity-50"></div>
                <div class="relative z-10">
                    <h1 class="text-4xl sm:text-5xl font-bold text-white dark:text-yellow-300">Biblioteca de Querys</h1>
                    <p class="text-lg text-gray-200 dark:text-gray-300 mt-2">Consultas optimizadas para el anÃ¡lisis de datos</p>
                </div>
            </header>

            <div id="query-search-container" class="mb-8 max-w-2xl mx-auto relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                <input type="text" id="query-search-input" class="block w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-full py-3 pl-10 pr-4 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar por tÃ­tulo o descripciÃ³n...">
            </div>

            <nav id="query-category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button data-category="all" class="nav-button active font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Todos</button>
                <button data-category="requests" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all admin-only-flex items-center gap-2">Solicitudes <span id="query-requests-count-badge" class="hidden bg-red-500 text-white text-xs w-5 h-5 rounded-full items-center justify-center">0</span></button>
                <button data-category="favorites" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">â˜… Favoritos</button>
                <button data-category="popular" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">ðŸ”¥ Populares</button>
                <button data-category="aforeglobal" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">AforeGlobal</button>
                <button data-category="safre" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Safre</button>
                <button data-category="notificaciones" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Notificaciones</button>
                <button data-category="admonafore" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">AdmonAfore</button>
                <button data-category="serviciosafore" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">ServiciosAfore</button>
                <button data-category="extra" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all">Extra</button>
                <button data-category="learn" class="nav-button font-medium py-2 px-4 rounded-full hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-book" viewBox="0 0 16 16"><path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.893V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.746c-.917-.432-2.107-.773-3.287-.893-1.093-.11-2.278-.06-3.213.493V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/></svg>
                    Aprende SQL
                </button>
            </nav>
            
            <main id="querys-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>

            <div id="sql-learning-section" class="hidden">
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">1. Conceptos Clave</h2>
                    <div class="space-y-5 text-gray-700 dark:text-gray-300">
                        <div class="flex items-start gap-3"><svg class="w-6 h-6 text-blue-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><p><strong>Â¿QuÃ© es un Query?</strong> Una pregunta a la base de datos.</p></div>
                        <div class="flex items-start gap-3"><svg class="w-6 h-6 text-blue-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><p><strong>Â¿QuÃ© es SQL?</strong> El lenguaje para hacer esa pregunta.</p></div>
                    </div>
                </div>
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">2. La FÃ³rmula MÃ¡gica</h2>
                    <div class="space-y-4 text-gray-700 dark:text-gray-300">
                        <p>Pasa el mouse sobre las palabras clave:</p>
                        <div id="interactive-sql-block" class="bg-gray-900 dark:bg-black/50 rounded-lg p-4 font-mono text-gray-300">
                            <span data-hover-target="exp-select" class="text-pink-400 font-bold cursor-pointer hover:underline">SELECT</span> <span data-hover-target="exp-all" class="text-gray-300 cursor-pointer hover:underline">*</span> <span data-hover-target="exp-from" class="text-pink-400 font-bold cursor-pointer hover:underline">FROM</span> <span data-hover-target="exp-table" class="text-green-400 cursor-pointer hover:underline">tabla_folios</span> <br> <span data-hover-target="exp-where" class="text-pink-400 font-bold cursor-pointer hover:underline">WHERE</span> <span data-hover-target="exp-condition" class="text-blue-300 cursor-pointer hover:underline">NSS = '123'</span>;
                        </div>
                        <div id="sql-explanation-box" class="p-3 bg-blue-50 dark:bg-gray-700 rounded-lg text-blue-800 dark:text-blue-200 min-h-[80px] transition-all">
                            <p id="exp-default" class="sql-explanation text-gray-500 dark:text-gray-400">Explora el cÃ³digo de arriba.</p>
                            <p id="exp-select" class="sql-explanation hidden font-medium"><strong>SELECT:</strong> QuÃ© columnas quieres ver.</p>
                            <p id="exp-all" class="sql-explanation hidden font-medium"><strong>*:</strong> Todas las columnas.</p>
                            <p id="exp-from" class="sql-explanation hidden font-medium"><strong>FROM:</strong> De quÃ© tabla.</p>
                            <p id="exp-table" class="sql-explanation hidden font-medium"><strong>Tabla:</strong> El archivo origen.</p>
                            <p id="exp-where" class="sql-explanation hidden font-medium"><strong>WHERE:</strong> El filtro.</p>
                            <p id="exp-condition" class="sql-explanation hidden font-medium"><strong>CondiciÃ³n:</strong> La regla a cumplir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading-indicator" class="text-center py-10"><p class="text-gray-500 dark:text-gray-400">Cargando datos...</p></div>
    </div>

    <footer class="text-center py-8 border-t border-gray-200 dark:border-gray-700">
        <p class="text-sm text-gray-500 dark:text-gray-400">Herramienta creada por la Gerencia de AtenciÃ³n al PÃºblico - Afore Coppel</p>
    </footer>

    <button id="add-item-btn" class="admin-only-flex fixed bottom-8 right-8 bg-blue-700 dark:bg-yellow-400 text-white dark:text-blue-900 w-16 h-16 rounded-full shadow-lg items-center justify-center text-3xl font-bold transform hover:scale-110 transition-transform z-30">+</button>

    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-blue-800 dark:text-yellow-400">Agregar Nuevo</h2>
            <form id="script-form">
                <input type="hidden" id="item-id">
                <div class="space-y-4">
                    <input type="text" id="item-title" placeholder="TÃ­tulo" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="item-description" placeholder="DescripciÃ³n breve" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="2"></textarea>
                    <textarea id="item-text" placeholder="Texto completo del script/query..." class="w-full p-2 border rounded font-mono dark:bg-gray-700 dark:border-gray-600" rows="6"></textarea>
                    <select id="item-category-script" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option value="">-- CategorÃ­a Script --</option><option value="unificacion">UnificaciÃ³n</option><option value="exp">Expediente</option><option value="parciales">Parciales</option><option value="totales">Totales</option><option value="extras">Extras</option></select>
                    <select id="item-category-query" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 hidden"><option value="">-- Servidor Query --</option><option value="aforeglobal">AforeGlobal</option><option value="safre">Safre</option><option value="notificaciones">Notificaciones</option><option value="admonafore">AdmonAfore</option><option value="serviciosafore">ServiciosAfore</option><option value="extra">Extra</option></select>
                    <input type="text" id="item-variables" placeholder="Variables (ej: FECHA, MONTO)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-btn" class="py-2 px-4 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Guardar</button>
                </div>
            </form>
             <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h2 class="text-xl font-bold mb-4">Â¿EstÃ¡s seguro?</h2><p id="delete-modal-text" class="text-gray-600 dark:text-gray-300 mb-6">...</p><div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="py-2 px-6 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">No</button><button id="confirm-delete-btn" class="py-2 px-6 rounded bg-red-600 text-white hover:bg-red-700">SÃ­</button></div></div></div>
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 relative"><h2 class="text-2xl font-bold mb-4 text-center text-blue-800 dark:text-yellow-400">Iniciar SesiÃ³n</h2><form id="login-form"><div class="space-y-4"><input type="email" id="login-email" placeholder="Correo electrÃ³nico" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><input type="password" id="login-password" placeholder="ContraseÃ±a" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><p id="login-error" class="text-red-500 text-sm text-center hidden"></p></div><div class="mt-6"><button type="submit" class="w-full py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Iniciar SesiÃ³n</button></div></form><button id="close-login-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button></div></div>
    <div id="register-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 relative"><h2 class="text-2xl font-bold mb-2 text-center text-blue-800 dark:text-yellow-400">Solicitar Acceso</h2><p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-6">Tu solicitud serÃ¡ enviada al Superadministrador.</p><form id="register-form"><div class="space-y-4"><input type="text" id="reg-name" placeholder="Nombre Completo" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><input type="email" id="reg-email" placeholder="Correo electrÃ³nico" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><input type="password" id="reg-password" placeholder="ContraseÃ±a" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><input type="text" id="reg-area" placeholder="Ãrea / Puesto" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div><div class="mt-6"><button type="submit" class="w-full py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500 font-bold transition-colors">Enviar Solicitud</button></div></form><button id="close-reg-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button></div></div>
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h2 id="info-modal-title" class="text-xl font-bold mb-4 text-blue-800 dark:text-yellow-400">NotificaciÃ³n</h2><p id="info-modal-text" class="text-gray-600 dark:text-gray-300 mb-6">...</p><button id="info-modal-close" class="py-2 px-6 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Entendido</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, increment, getDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAvq0CF94lVwGZAtXiFZKHwS5q4ZA489lM", authDomain: "scripts-une-gap.firebaseapp.com", projectId: "scripts-une-gap", storageBucket: "scripts-une-gap.firebasestorage.app", messagingSenderId: "567975326387", appId: "1:567975326387:web:28edbab67668d1a829f6c6", measurementId: "G-GJK53TR2D6" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const scriptsCol = collection(db, 'scripts'), querysCol = collection(db, 'querys'), requestsCol = collection(db, 'solicitudes'), queryRequestsCol = collection(db, 'solicitudes_querys'), userRolesCol = collection(db, 'user_roles');
        let currentView = 'scripts', currentUserRole = null, currentUser = null, favorites = JSON.parse(localStorage.getItem('favoriteScripts'))||[], queryFavorites = JSON.parse(localStorage.getItem('favoriteQuerys'))||[];
        const copiedScripts = new Set(), copiedQuerys = new Set();
        let allScripts = [], pendingRequests = [], pendingUsers = [], allQuerys = [], pendingQueryRequests = [];

        // DOM
        const gatekeeper = document.getElementById('gatekeeper'), appContainer = document.getElementById('app-container');
        const scriptsContainer = document.getElementById('scripts-container'), querysContainer = document.getElementById('querys-container');
        const loadingIndicator = document.getElementById('loading-indicator'), authControls = document.getElementById('auth-controls');
        const learningSection = document.getElementById('sql-learning-section'), querySearchContainer = document.getElementById('query-search-container');

        // Auth
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.getElementById('gatekeeper-loading').classList.remove('hidden'); document.getElementById('gatekeeper-actions').classList.add('hidden');
                try {
                    const docSnap = await getDoc(doc(userRolesCol, user.uid));
                    if(docSnap.exists() && docSnap.data().status === 'active') {
                        currentUser = user; currentUserRole = docSnap.data().role;
                        authControls.innerHTML = `<div class="flex flex-col items-end mr-2 hidden sm:flex"><span class="text-xs font-bold text-blue-800 dark:text-yellow-400">${docSnap.data().displayName || 'Usuario'}</span><span class="text-[10px] text-gray-500 dark:text-gray-400">${currentUserRole.toUpperCase()}</span></div><button id="logout-btn" class="text-sm font-bold text-red-500 border border-red-200 px-2 py-1 rounded hover:bg-red-50">Salir</button>`;
                        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                        setupListeners();
                        gatekeeper.classList.add('opacity-0'); setTimeout(() => { gatekeeper.classList.add('hidden'); appContainer.classList.remove('hidden'); setTimeout(() => appContainer.classList.remove('opacity-0'), 50); }, 500);
                        document.body.classList.toggle('admin-mode', currentUserRole === 'superadmin' || currentUserRole === 'admin');
                    } else { alert("Cuenta pendiente de aprobaciÃ³n o no activa."); await signOut(auth); resetGatekeeper(); }
                } catch(e) { console.error(e); alert("Error de conexiÃ³n."); await signOut(auth); resetGatekeeper(); }
            } else { resetGatekeeper(); }
        });

        function resetGatekeeper() { gatekeeper.classList.remove('hidden', 'opacity-0'); appContainer.classList.add('hidden', 'opacity-0'); document.getElementById('gatekeeper-loading').classList.add('hidden'); document.getElementById('gatekeeper-actions').classList.remove('hidden'); authControls.innerHTML = ''; currentUser = null; }
        function setupListeners() {
            onSnapshot(scriptsCol, (snap) => { allScripts = snap.docs.map(d => ({id: d.id, ...d.data()})); if(currentView === 'scripts') applyScriptFilters(); loadingIndicator.style.display = 'none'; });
            onSnapshot(querysCol, (snap) => { allQuerys = snap.docs.map(d => ({id: d.id, ...d.data()})); if(currentView === 'querys') applyQueryFilters(); });
            if(currentUserRole === 'superadmin') { onSnapshot(requestsCol, (snap) => pendingRequests = snap.docs.map(d => ({id: d.id, data: d.data()}))); onSnapshot(queryRequestsCol, (snap) => pendingQueryRequests = snap.docs.map(d => ({id: d.id, data: d.data()}))); onSnapshot(userRolesCol, (snap) => { pendingUsers = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(u => u.status === 'pending'); updateBadgeCount(); }); }
        }

        // Renders
        function renderScripts(list) {
            scriptsContainer.innerHTML = ''; const isPop = document.querySelector('#category-filters .active').dataset.category === 'popular';
            if(list.length === 0) scriptsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay resultados</p>';
            list.forEach(s => {
                const card = document.createElement('div'); card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all flex flex-col card-enter mb-6'; card.dataset.id = s.id; card.dataset.type = 'scripts';
                let flame = isPop ? `<div class="absolute top-3 right-20 text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-bold">ðŸ”¥ ${s.copyCount||0}</div>` : '';
                let star = !isPop ? `<button class="favorite-btn absolute top-2 right-2 text-gray-400 hover:text-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="${favorites.includes(s.id)?'text-yellow-400':'text-gray-400'}" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg></button>` : '';
                let vars = s.variables && s.variables.length > 0 ? `<div class="mt-4 border-t pt-3"><h4 class="text-sm font-bold mb-2 text-gray-500">Variables:</h4>${s.variables.map(v=>`<div class="flex gap-2 mb-1 items-center"><label class="text-xs font-mono w-1/3 truncate" title="${v}">${v}:</label><input class="variable-input w-2/3 border rounded text-sm p-1 dark:bg-gray-700" data-variable-name="${v}" placeholder="Valor..."></div>`).join('')}</div>` : '';
                let admin = `<div class="admin-only-flex absolute top-2 right-10 z-10"><button class="options-btn p-1 text-gray-400 hover:text-blue-500 text-xl">â€¢â€¢â€¢</button><div class="options-menu absolute right-0 mt-2 w-32 bg-white dark:bg-gray-700 shadow-lg hidden z-20 rounded border dark:border-gray-600"><a href="#" class="edit-btn block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600">Editar</a><a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-600">Borrar</a></div></div>`;
                card.innerHTML = `${flame}${admin}<div class="p-6 flex-grow"><div class="flex justify-between items-start"><h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 pr-16 mb-2">${s.title}</h2>${star}</div><p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${s.description}</p><div class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg text-sm max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700"><pre class="script-content font-sans text-gray-700 dark:text-gray-200">${s.scriptText}</pre></div>${vars}</div><div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"><button class="copy-btn w-full bg-yellow-400 text-blue-900 font-bold py-2 rounded-lg transition-colors hover:bg-yellow-500">Copiar Script</button></div>`;
                if(copiedScripts.has(s.id)) { const btn = card.querySelector('.copy-btn'); btn.textContent = 'Â¡Copiado!'; btn.classList.add('copied'); }
                scriptsContainer.appendChild(card);
            });
        }

        function renderQuerys(list) {
            querysContainer.innerHTML = ''; const isPop = document.querySelector('#query-category-filters .active').dataset.category === 'popular';
            if(list.length === 0) querysContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay resultados</p>';
            list.forEach(q => {
                const card = document.createElement('div'); card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all flex flex-col card-enter mb-6'; card.dataset.id = q.id; card.dataset.type = 'query';
                let flame = isPop ? `<div class="absolute top-3 right-20 text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-bold">ðŸ”¥ ${q.copyCount||0}</div>` : '';
                let star = !isPop ? `<button class="favorite-btn absolute top-2 right-2 text-gray-400 hover:text-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="${queryFavorites.includes(q.id)?'text-yellow-400':'text-gray-400'}" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg></button>` : '';
                let admin = `<div class="admin-only-flex absolute top-2 right-10 z-10"><button class="options-btn p-1 text-gray-400 hover:text-blue-500 text-xl">â€¢â€¢â€¢</button><div class="options-menu absolute right-0 mt-2 w-32 bg-white dark:bg-gray-700 shadow-lg hidden z-20 rounded border dark:border-gray-600"><a href="#" class="edit-btn block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600">Editar</a><a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-600">Borrar</a></div></div>`;
                const serverMap = { 'aforeglobal': 'AforeGlobal', 'safre': 'Safre', 'notificaciones': 'Notificaciones', 'admonafore': 'AdmonAfore', 'serviciosafore': 'ServiciosAfore', 'extra': 'Extra' };
                const serverName = serverMap[q.category] || q.category;
                card.innerHTML = `${flame}${admin}<div class="p-6 flex-grow"><div class="flex justify-between items-start"><h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 pr-16 mb-2">${q.title}</h2>${star}</div><p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${q.description}</p><div class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg text-sm max-h-32 overflow-y-auto border border-gray-200 dark:border-gray-700"><pre class="script-content font-mono text-gray-700 dark:text-gray-200">${q.scriptText}</pre></div><div class="mt-4 border-t pt-2 text-xs font-bold text-gray-500 uppercase tracking-wide">Servidor: <span class="text-blue-600 dark:text-yellow-400">${serverName}</span></div></div><div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"><button class="copy-btn w-full bg-yellow-400 text-blue-900 font-bold py-2 rounded-lg transition-colors hover:bg-yellow-500">Copiar Query</button></div>`;
                if(copiedQuerys.has(q.id)) { const btn = card.querySelector('.copy-btn'); btn.textContent = 'Â¡Copiado!'; btn.classList.add('copied'); }
                querysContainer.appendChild(card);
            });
        }

        function updateBadgeCount() {
             const count = pendingRequests.length + pendingQueryRequests.length + pendingUsers.length;
             document.getElementById('requests-count-badge').textContent = count; document.getElementById('requests-count-badge').classList.toggle('hidden', count === 0);
             document.getElementById('query-requests-count-badge').textContent = count; document.getElementById('query-requests-count-badge').classList.toggle('hidden', count === 0);
             const active = document.querySelector('#category-filters .active'); if(active && active.dataset.category === 'requests') renderCombinedRequests();
        }

        function applyScriptFilters() {
            const term = document.getElementById('search-input').value.toLowerCase(); const cat = document.querySelector('#category-filters .active').dataset.category;
            if(cat === 'requests') { renderCombinedRequests(); return; }
            let filtered = allScripts;
            if(cat === 'favorites') filtered = filtered.filter(s => favorites.includes(s.id));
            else if(cat === 'popular') filtered = [...filtered].sort((a,b) => (b.copyCount||0) - (a.copyCount||0));
            else if(cat !== 'all') filtered = filtered.filter(s => s.category === cat);
            if(term) filtered = filtered.filter(s => s.title.toLowerCase().includes(term) || s.description.toLowerCase().includes(term));
            renderScripts(filtered);
        }

        function applyQueryFilters() {
            const term = document.getElementById('query-search-input').value.toLowerCase(); const cat = document.querySelector('#query-category-filters .active').dataset.category;
            if(cat === 'requests') { renderCombinedRequests(); return; }
            let filtered = allQuerys;
            if(cat === 'favorites') filtered = filtered.filter(q => queryFavorites.includes(q.id));
            else if(cat === 'popular') filtered = [...filtered].sort((a,b) => (b.copyCount||0) - (a.copyCount||0));
            else if(cat !== 'all' && cat !== 'learn') filtered = filtered.filter(q => q.category === cat);
            if(term) filtered = filtered.filter(q => q.title.toLowerCase().includes(term) || q.description.toLowerCase().includes(term));
            renderQuerys(filtered);
        }

        function renderCombinedRequests() {
            const container = currentView === 'scripts' ? scriptsContainer : querysContainer;
            container.innerHTML = '';
            if(pendingUsers.length === 0 && pendingRequests.length === 0 && pendingQueryRequests.length === 0) { container.innerHTML = '<p class="text-center col-span-3 text-gray-500">No hay solicitudes.</p>'; return; }
            pendingUsers.forEach(u => {
                container.innerHTML += `<div class="bg-blue-50 dark:bg-gray-800 border-l-4 border-blue-500 p-4 rounded shadow"><h4 class="font-bold text-blue-800 dark:text-blue-400">USUARIO NUEVO</h4><p class="font-bold">${u.displayName}</p><p class="text-sm">${u.email} - ${u.area}</p><div class="mt-2 flex gap-2"><button onclick="approveUser('${u.id}', true)" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Aprobar</button><button onclick="approveUser('${u.id}', false)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">Rechazar</button></div></div>`;
            });
            [...pendingRequests, ...pendingQueryRequests].forEach(r => {
                const d = r.data;
                container.innerHTML += `<div class="bg-white dark:bg-gray-800 p-4 rounded shadow border dark:border-gray-700 relative"><span class="absolute top-2 right-2 text-xs bg-yellow-200 text-black px-2 rounded font-bold">${d.action.toUpperCase()}</span><h4 class="font-bold text-lg">${d.title}</h4><p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${d.description}</p><div class="flex gap-2 mt-2"><button onclick="handleRequest('${r.id}', '${r.data.category ? 'script' : 'query'}', true)" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Aprobar</button><button onclick="handleRequest('${r.id}', '${r.data.category ? 'script' : 'query'}', false)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">Rechazar</button></div></div>`;
            });
        }

        // Click Events
        document.body.addEventListener('click', async (e) => {
            // Copiar
            const copyBtn = e.target.closest('.copy-btn');
            if(copyBtn) {
                const card = copyBtn.closest('[data-id]'); const type = card.dataset.type; const id = card.dataset.id;
                let textToCopy = card.querySelector('.script-content').textContent;
                if(type === 'scripts') { card.querySelectorAll('.variable-input').forEach(input => { const varName = input.dataset.variableName; const val = input.value || `[${varName}]`; textToCopy = textToCopy.replaceAll(varName, val); }); }
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    const col = type === 'scripts' ? scriptsCol : querysCol; const set = type === 'scripts' ? copiedScripts : copiedQuerys;
                    set.add(id); updateDoc(doc(col, id), { copyCount: increment(1) });
                    type === 'scripts' ? applyScriptFilters() : applyQueryFilters();
                    setTimeout(() => { set.delete(id); type === 'scripts' ? applyScriptFilters() : applyQueryFilters(); }, 2000);
                } catch(err) { console.error(err); }
            }
            // Favs
            const favBtn = e.target.closest('.favorite-btn');
            if(favBtn) {
                const card = favBtn.closest('[data-id]'); const id = card.dataset.id; const type = card.dataset.type;
                const list = type === 'scripts' ? favorites : queryFavorites; const key = type === 'scripts' ? 'favoriteScripts' : 'favoriteQuerys';
                const idx = list.indexOf(id); if(idx > -1) list.splice(idx, 1); else list.push(id);
                localStorage.setItem(key, JSON.stringify(list)); type === 'scripts' ? applyScriptFilters() : applyQueryFilters();
            }
            // Menus
            const optBtn = e.target.closest('.options-btn');
            if(optBtn) { document.querySelectorAll('.options-menu').forEach(m => m.classList.add('hidden')); optBtn.nextElementSibling.classList.remove('hidden'); e.stopPropagation(); }
            else if (!e.target.closest('.options-menu')) document.querySelectorAll('.options-menu').forEach(m => m.classList.add('hidden'));
            // Edit/Delete
            if(e.target.closest('.edit-btn')) { e.preventDefault(); const card = e.target.closest('[data-id]'); openEditModal(card.dataset.id, card.dataset.type); }
            if(e.target.closest('.delete-btn')) { e.preventDefault(); const card = e.target.closest('[data-id]'); openDeleteModal(card.dataset.id, card.dataset.type); }
        });

        // Modals Logic
        const itemModal = document.getElementById('add-item-modal'), itemForm = document.getElementById('script-form'), itemIdInput = document.getElementById('item-id');
        document.getElementById('add-item-btn').onclick = () => { itemForm.reset(); itemIdInput.value = ''; const isScript = currentView === 'scripts'; document.getElementById('item-category-script').classList.toggle('hidden', !isScript); document.getElementById('item-category-query').classList.toggle('hidden', isScript); document.getElementById('item-variables').classList.toggle('hidden', !isScript); document.getElementById('modal-title').textContent = isScript ? "Nuevo Script" : "Nueva Query"; openModal(itemModal); };
        
        function openEditModal(id, type) {
            const list = type === 'scripts' ? allScripts : allQuerys; const item = list.find(i => i.id === id); if(!item) return;
            itemIdInput.value = id; document.getElementById('item-title').value = item.title; document.getElementById('item-description').value = item.description; document.getElementById('item-text').value = item.scriptText;
            if(type === 'scripts') { document.getElementById('item-category-script').value = item.category; document.getElementById('item-variables').value = (item.variables || []).join(', '); document.getElementById('item-category-script').classList.remove('hidden'); document.getElementById('item-category-query').classList.add('hidden'); document.getElementById('item-variables').classList.remove('hidden'); }
            else { document.getElementById('item-category-query').value = item.category; document.getElementById('item-category-script').classList.add('hidden'); document.getElementById('item-category-query').classList.remove('hidden'); document.getElementById('item-variables').classList.add('hidden'); }
            document.getElementById('modal-title').textContent = "Editar"; openModal(itemModal);
        }

        itemForm.onsubmit = async (e) => {
            e.preventDefault(); const id = itemIdInput.value; const isScript = currentView === 'scripts'; const col = isScript ? scriptsCol : querysCol; const reqCol = isScript ? requestsCol : queryRequestsCol;
            const data = { title: document.getElementById('item-title').value, description: document.getElementById('item-description').value, scriptText: document.getElementById('item-text').value, category: isScript ? document.getElementById('item-category-script').value : document.getElementById('item-category-query').value, variables: isScript ? document.getElementById('item-variables').value.split(',').map(v=>v.trim()).filter(v=>v) : [], updatedAt: serverTimestamp() };
            try { if(currentUserRole === 'superadmin') { if(id) await updateDoc(doc(col, id), data); else { data.copyCount = 0; await addDoc(col, data); } } else { await addDoc(reqCol, { ...data, action: id?'edit':'add', originalId: id||null, status:'pending', requestedBy: currentUser.uid }); alert("Solicitud enviada."); } closeModal(itemModal); } catch(err) { alert(err.message); }
        };

        // Delete
        let deleteTarget = null;
        function openDeleteModal(id, type) { deleteTarget = { id, type }; document.getElementById('delete-modal-text').textContent = currentUserRole === 'superadmin' ? "Â¿Eliminar permanentemente?" : "Â¿Solicitar eliminaciÃ³n?"; openModal(document.getElementById('delete-confirm-modal')); }
        document.getElementById('confirm-delete-btn').onclick = async () => {
            if(!deleteTarget) return; const { id, type } = deleteTarget; const col = type === 'scripts' ? scriptsCol : querysCol; const reqCol = type === 'scripts' ? requestsCol : queryRequestsCol; const list = type === 'scripts' ? allScripts : allQuerys;
            try { if(currentUserRole === 'superadmin') await deleteDoc(doc(col, id)); else { const item = list.find(i => i.id === id); await addDoc(reqCol, { ...item, action:'delete', originalId: id, status:'pending', requestedBy: currentUser.uid }); alert("Solicitud enviada."); } closeModal(document.getElementById('delete-confirm-modal')); } catch(err) { alert(err.message); }
        };

        // Global Helpers
        window.approveUser = async (uid, approve) => { if(approve) await updateDoc(doc(userRolesCol, uid), { status: 'active', role: 'viewer' }); else if(confirm("Â¿Rechazar?")) await deleteDoc(doc(userRolesCol, uid)); };
        window.handleRequest = async (rid, type, approve) => {
            const reqCol = type === 'script' ? requestsCol : queryRequestsCol; const mainCol = type === 'script' ? scriptsCol : querysCol;
            if(approve) { const snap = await getDoc(doc(reqCol, rid)); const d = snap.data(); const data = { title:d.title, description:d.description, scriptText:d.scriptText, category:d.category, variables:d.variables||[], updatedAt: serverTimestamp() }; if(d.action === 'add') { data.copyCount = 0; await addDoc(mainCol, data); } else if(d.action === 'edit') await updateDoc(doc(mainCol, d.originalId), data); else if(d.action === 'delete') await deleteDoc(doc(mainCol, d.originalId)); }
            await deleteDoc(doc(reqCol, rid));
        };

        // Nav
        document.querySelectorAll('#main-nav button').forEach(btn => { btn.onclick = () => { document.querySelector('.main-nav-btn.active').classList.remove('active'); btn.classList.add('active'); currentView = btn.dataset.view; if(currentView === 'scripts') { document.getElementById('scripts-page-container').classList.remove('hidden'); document.getElementById('querys-page-container').classList.add('hidden'); applyScriptFilters(); } else { document.getElementById('scripts-page-container').classList.add('hidden'); document.getElementById('querys-page-container').classList.remove('hidden'); applyQueryFilters(); } } });
        
        // LÃ“GICA APRENDE SQL Y FILTROS
        document.querySelectorAll('#category-filters button, #query-category-filters button').forEach(btn => {
            btn.onclick = (e) => {
                const nav = e.target.closest('nav');
                nav.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                
                if(e.target.dataset.category === 'learn') {
                    document.getElementById('querys-container').classList.add('hidden');
                    document.getElementById('query-search-container').classList.add('hidden');
                    document.getElementById('sql-learning-section').classList.remove('hidden');
                } else {
                    if(currentView === 'querys') {
                        document.getElementById('sql-learning-section').classList.add('hidden');
                        document.getElementById('query-search-container').classList.remove('hidden');
                        document.getElementById('querys-container').classList.remove('hidden');
                        applyQueryFilters();
                    } else {
                        applyScriptFilters();
                    }
                }
            }
        });

        document.getElementById('search-input').oninput = applyScriptFilters; document.getElementById('query-search-input').oninput = applyQueryFilters;
        
        // Modals Utils
        function openModal(el) { el.classList.remove('hidden'); setTimeout(()=>el.classList.remove('opacity-0'),10); }
        function closeModal(el) { el.classList.add('opacity-0'); setTimeout(()=>el.classList.add('hidden'),300); }
        document.getElementById('btn-landing-login').onclick = () => openModal(document.getElementById('login-modal')); document.getElementById('btn-landing-register').onclick = () => openModal(document.getElementById('register-modal'));
        document.querySelectorAll('[id^="close-"], #cancel-btn, #cancel-delete-btn, #info-modal-close').forEach(b => b.addEventListener('click', (e) => closeModal(e.target.closest('div.fixed'))));
        document.getElementById('login-form').onsubmit = async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); closeModal(document.getElementById('login-modal')); } catch(e) { document.getElementById('login-error').textContent=e.message; document.getElementById('login-error').classList.remove('hidden'); } };
        document.getElementById('register-form').onsubmit = async (e) => { e.preventDefault(); try { const cred = await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-password').value); await setDoc(doc(userRolesCol, cred.user.uid), { email: cred.user.email, displayName: document.getElementById('reg-name').value, area: document.getElementById('reg-area').value, role: 'viewer', status: 'pending' }); alert("Solicitud enviada."); await signOut(auth); closeModal(document.getElementById('register-modal')); } catch(e) { alert(e.message); } };

        // LÃ“GICA MODO OSCURO (Restaurada)
        const themeToggle = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');

        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            lightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            darkIcon.classList.remove('hidden');
        }

        themeToggle.addEventListener('click', function() {
            darkIcon.classList.toggle('hidden');
            lightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });

        // INTERACTIVIDAD APRENDE SQL (Restaurada)
        const interactiveBlock = document.getElementById('interactive-sql-block');
        const explanationBox = document.getElementById('sql-explanation-box');
        if(interactiveBlock && explanationBox) {
            const targets = interactiveBlock.querySelectorAll('[data-hover-target]');
            const explanations = explanationBox.querySelectorAll('.sql-explanation');
            targets.forEach(t => {
                t.addEventListener('mouseover', () => {
                    explanations.forEach(e => e.classList.add('hidden'));
                    document.getElementById(t.dataset.hoverTarget).classList.remove('hidden');
                });
                t.addEventListener('mouseleave', () => {
                    explanations.forEach(e => e.classList.add('hidden'));
                    document.getElementById('exp-default').classList.remove('hidden');
                });
            });
        }
    </script>
</body>
</html>









































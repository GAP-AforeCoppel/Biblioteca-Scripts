<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca de Scripts CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #1d4ed8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #1e40af; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #fbbF24; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
        .script-content { white-space: pre-wrap; word-wrap: break-word; }
        .nav-button.active { background-color: #1d4ed8; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark .nav-button.active { background-color: #fbbF24; color: #111827; }
        #add-item-modal, #delete-confirm-modal, #login-modal, #info-modal { transition: opacity 0.3s ease; }
        
        /* Reglas de visibilidad para Admin */
        .admin-only-flex { display: none !important; }
        body.admin-mode .admin-only-flex { display: flex !important; }

        /* Estilo para el bot√≥n de copiar confirmado */
        .copy-btn.copied {
            background-color: #16a34a !important; /* Verde brillante (Tailwind green-600) */
            color: white !important;
        }
        .copy-btn.copied:hover {
            background-color: #15803d !important; /* Tono m√°s oscuro al pasar el mouse (green-700) */
        }

        /* Animaci√≥n de entrada para tarjetas */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; }
        }
        .card-enter {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Estilos para el Navegador Principal de Pesta√±as */
        .main-nav-btn {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .main-nav-btn.active {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .dark .main-nav-btn.active {
            background-color: #fbbF24; /* yellow-400 */
            color: #111827; /* gray-900 */
        }
        
        /* Estilo para las p√≠ldoras de c√≥digo en la secci√≥n de aprendizaje */
        .code-pill {
            background-color: #dbeafe; /* blue-100 */
            color: #1e40af; /* blue-800 */
            font-family: monospace;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.125rem 0.5rem; /* px-2 py-0.5 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
        }
        .dark .code-pill {
            background-color: #374151; /* gray-700 */
            color: #93c5fd; /* blue-300 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 transition-colors duration-300">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <div class="flex justify-between items-center py-4 px-2 mb-6">
            <div class="flex items-center gap-4">
                <img src="logoafore.png" alt="Logo Afore Coppel" class="h-14" onerror="this.alt='Logo Afore Coppel'; this.style.display='none';">
                <div class="border-l border-gray-300 dark:border-gray-600 h-14"></div>
                <img src="logogap.png" alt="Logo Gerencia de Atenci√≥n al P√∫blico" class="w-24" onerror="this.alt='Logo Gerencia'; this.style.display='none';">
            </div>
            <div class="flex items-center gap-4">
                <div id="auth-controls"></div>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                    <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>

        <!-- =========== NAVEGACI√ìN PRINCIPAL (SCRIPTS/QUERYS) =========== -->
        <div id="main-nav" class="flex flex-wrap justify-center gap-4 mb-8">
            <button data-view="scripts" class="main-nav-btn active flex items-center gap-2 font-medium py-3 px-6 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zM6.028 3.85a.5.5 0 0 1 .5-.5h2.944a.5.5 0 0 1 .5.5v.35c0 .34-.14.66-.38.89l-1.2 1.196a.5.5 0 0 0-.14.34V8.5a.5.5 0 0 1-1 0V6.626a.5.5 0 0 0-.14-.34L6.409 5.09a.5.5 0 0 1-.38-.89v-.35zM4 11.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z"/><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H4z"/></svg>
                Scripts
            </button>
            <button data-view="querys" class="main-nav-btn flex items-center gap-2 font-medium py-3 px-6 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.026a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V1.026zM5 1.526v3.448h6V1.526H5z"/><path d="M12.5 6a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V6.5a.5.5 0 0 1 .5-.5h7zM5 6.526v3.448h6V6.526H5z"/><path d="M4 11.026a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V11.026zM5 11.526v3.448h6v-3.448H5z"/></svg>
                Querys
            </button>
        </div>

        <!-- =========== CONTENEDOR DE P√ÅGINA DE SCRIPTS =========== -->
        <div id="scripts-page-container">
            <header class="relative text-center mb-8 bg-cover bg-center rounded-lg shadow-lg overflow-hidden py-40" style="background-image: url('cafe.png'); background-color: #2c3e50;">
                <div class="absolute inset-0 bg-blue-900 bg-opacity-50"></div>
                <div class="relative z-10">
                    <h1 id="script-page-title" class="text-4xl sm:text-5xl font-bold text-white dark:text-yellow-300">Biblioteca de Scripts</h1>
                    <p id="script-page-slogan" class="text-lg text-gray-200 dark:text-gray-300 mt-2">Soluciones r√°pidas para casos de CRM en Salesforce</p>
                </div>
            </header>

            <div class="mb-8 max-w-2xl mx-auto">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                         <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="text" id="search-input" class="block w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-full py-3 pl-10 pr-4 text-gray-900 dark:text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-yellow-500 transition" placeholder="Buscar por t√≠tulo o descripci√≥n...">
                </div>
            </div>

            <nav id="category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button data-category="all" class="nav-button active font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Todos</button>
                <button data-category="requests" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md admin-only-flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-inbox" viewBox="0 0 16 16"><path d="M4.38 1C3.242 1 2.22 1.8 2.034 2.818L.03 10.873A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.47-2.127L13.966 2.818A2 2 0 0 0 11.62 1H4.38zM1 2.81C1.002 2.7 1 2.58 1 2.5a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1c0 .08-.002.199-.034.31L13.06 10.37A.5.5 0 0 1 12.5 10.5h-11a.5.5 0 0 1-.56-.37L1 2.81zm13.38 9.19-2.75-2.75a.5.5 0 0 0-.707 0L8 12.207l-1.42-1.42a.5.5 0 0 0-.707 0L3.12 13.5H1.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1h-1.12z"/></svg>
                    Solicitudes
                    <span id="requests-count-badge" class="hidden ml-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full items-center justify-center">0</span>
                </button>
                <button data-category="favorites" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">‚òÖ Favoritos</button>
                <button data-category="popular" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">üî• Populares</button>
                <button data-category="unificacion" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Unificaci√≥n/Separaci√≥n</button>
                <button data-category="exp" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Exp. y Serv.</button>
                <button data-category="parciales" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Retiros Parciales</button>
                <button data-category="totales" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Retiros Totales</button>
                <button data-category="extras" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Extras</button>
            </nav>
            
            <main id="scripts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
        </div>

        <!-- =========== CONTENEDOR DE P√ÅGINA DE QUERYS =========== -->
        <div id="querys-page-container" class="hidden">
            <header class="relative text-center mb-8 bg-cover bg-center rounded-lg shadow-lg overflow-hidden py-40" style="background-image: url('cafe.png'); background-color: #2c3e50;"> <!-- Color de fallback -->
                <div class="absolute inset-0 bg-blue-900 bg-opacity-50"></div>
                <div class="relative z-10">
                    <h1 id="query-page-title" class="text-4xl sm:text-5xl font-bold text-white dark:text-yellow-300">Biblioteca de Querys</h1>
                    <p id="query-page-slogan" class="text-lg text-gray-200 dark:text-gray-300 mt-2">Consultas optimizadas para el an√°lisis de datos</p>
                </div>
            </header>

            <div id="query-search-container" class="mb-8 max-w-2xl mx-auto">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                         <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="text" id="query-search-input" class="block w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-full py-3 pl-10 pr-4 text-gray-900 dark:text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-yellow-500 transition" placeholder="Buscar por t√≠tulo o descripci√≥n...">
                </div>
            </div>

            <nav id="query-category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button data-category="all" class="nav-button active font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Todos</button>
                <button data-category="requests" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md admin-only-flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-inbox" viewBox="0 0 16 16"><path d="M4.38 1C3.242 1 2.22 1.8 2.034 2.818L.03 10.873A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.47-2.127L13.966 2.818A2 2 0 0 0 11.62 1H4.38zM1 2.81C1.002 2.7 1 2.58 1 2.5a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1c0 .08-.002.199-.034.31L13.06 10.37A.5.5 0 0 1 12.5 10.5h-11a.5.5 0 0 1-.56-.37L1 2.81zm13.38 9.19-2.75-2.75a.5.5 0 0 0-.707 0L8 12.207l-1.42-1.42a.5.5 0 0 0-.707 0L3.12 13.5H1.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1h-1.12z"/></svg>
                    Solicitudes
                    <span id="query-requests-count-badge" class="hidden ml-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full items-center justify-center">0</span>
                </button>
                <button data-category="favorites" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">‚òÖ Favoritos</button>
                <button data-category="popular" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">üî• Populares</button>
                <button data-category="aforeglobal" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">AforeGlobal</button>
                <button data-category="safre" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Safre</button>
                <button data-category="notificaciones" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Notificaciones</button>
                <button data-category="admonafore" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">AdmonAfore</button>
                <button data-category="serviciosafore" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">ServiciosAfore</button>
                <button data-category="extra" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Extra</button>
                <button data-category="learn" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-book" viewBox="0 0 16 16">
                      <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.893V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.746c-.917-.432-2.107-.773-3.287-.893-1.093-.11-2.278-.06-3.213.493V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                    </svg>
                    Aprende SQL
                </button>
            </nav>
            
            <!-- Contenedor de las tarjetas de querys (se oculta) -->
            <main id="querys-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>

            <!-- M√ìDULO DE APRENDIZAJE MOVIDO AQU√ç (oculto por defecto) -->
            <div id="sql-learning-section" class="hidden">
                <!-- M√≥dulo 1: Conceptos -->
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">1. Conceptos Clave (¬øQu√© es esto?)</h2>
                    <div class="space-y-5 text-gray-700 dark:text-gray-300">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-blue-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <p><strong>¬øQu√© es un Query?</strong> Es simplemente una pregunta o "consulta" que le hacemos a la base de datos para que nos traiga informaci√≥n espec√≠fica.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-blue-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <p><strong>¬øQu√© es SQL?</strong> Es el idioma que usamos para escribir esa pregunta. (Significa "Lenguaje de Consulta Estructurada").</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-green-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <p><strong>La Analog√≠a de Excel (Para entender la BD):</strong> Piensa en la base de datos como un archivo de Excel gigante.</p>
                        </div>
                        <div class="ml-10 p-4 border-l-2 border-gray-200 dark:border-gray-600 space-y-2">
                            <p class="font-semibold"><strong>Servidor:</strong> Es el archivo .xlsx completo.</p>
                            <p class="ml-4 font-semibold"><strong>Tabla:</strong> Es una hoja o pesta√±a (ej. "Folios").</p>
                            <p class="ml-8 font-semibold"><strong>Valores:</strong> Son las celdas de esa hoja.</p>
                        </div>
                    </div>
                </div>
                <!-- M√≥dulo 2: F√≥rmula M√°gica -->
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">2. La F√≥rmula M√°gica (C√≥mo LEER un Query)</h2>
                    <div class="space-y-4 text-gray-700 dark:text-gray-300">
                        <p>Casi todos los querys de consulta que usaremos se leen con esta f√≥rmula de 3 partes. Pasa el mouse sobre las palabras clave para ver qu√© hacen.</p>
                        
                        <!-- Bloque de C√≥digo Interactivo -->
                        <div id="interactive-sql-block" class="bg-gray-900 dark:bg-black/50 rounded-lg p-4 font-mono text-gray-300">
                            <span data-hover-target="exp-select" class="text-pink-400 font-bold cursor-pointer hover:underline">SELECT</span>
                            <span data-hover-target="exp-all" class_base="text-gray-300" class="text-gray-300 cursor-pointer hover:underline"> * </span>
                            <span data-hover-target="exp-from" class="text-pink-400 font-bold cursor-pointer hover:underline">FROM</span>
                            <span data-hover-target="exp-table" class_base="text-green-400" class="text-green-400 cursor-pointer hover:underline"> tabla_folios_salesforce</span>
                            <br>
                            <span data-hover-target="exp-where" class="text-pink-400 font-bold cursor-pointer hover:underline">WHERE</span>
                            <span data-hover-target="exp-condition" class_base="text-blue-300" class="text-blue-300 cursor-pointer hover:underline"> NSS = '123456789'</span>;
                        </div>
                        
                        <!-- Caja de Explicaci√≥n -->
                        <div id="sql-explanation-box" class="p-3 bg-blue-50 dark:bg-gray-700 rounded-lg text-blue-800 dark:text-blue-200 min-h-[80px] transition-all">
                            <p id="exp-default" class="sql-explanation text-gray-500 dark:text-gray-400">Pasa el mouse sobre las partes del query para ver qu√© hacen.</p>
                            <p id="exp-select" class="sql-explanation hidden font-medium"><strong>1. SELECT (El "Qu√©"):</strong> Elige qu√© columnas quieres ver. <br><code>SELECT Folio, Estatus</code> significa "Selecciona solo esas dos columnas".</p>
                            <p id="exp-all" class="sql-explanation hidden font-medium"><strong>El Asterisco (*):</strong> Es un comod√≠n que significa "TODO". <br><code>SELECT *</code> es la forma r√°pida de decir "Tr√°eme todas las columnas de la tabla".</p>
                            <p id="exp-from" class="sql-explanation hidden font-medium"><strong>2. FROM (El "D√≥nde"):</strong> Indica de qu√© tabla (u 'hoja de Excel') quieres sacar los datos.</p>
                            <p id="exp-table" class="sql-explanation hidden font-medium"><strong>Nombre de la Tabla:</strong> El lugar espec√≠fico de donde vienen los datos. En tu analog√≠a, es el nombre de la "hoja de Excel".</p>
                            <p id="exp-where" class="sql-explanation hidden font-medium"><strong>3. WHERE (El "Filtro"):</strong> La condici√≥n para filtrar. ¬°Esta es la parte m√°s importante para el diagn√≥stico!</p>
                            <p id="exp-condition" class="sql-explanation hidden font-medium"><strong>La Condici√≥n:</strong> La regla que deben cumplir las filas para ser seleccionadas. <br>Ej: <code>NSS = '123456789'</code> o <code>Numero_del_caso = '00654321'</code>.</p>
                        </div>
                    </div>
                </div>
                <!-- M√≥dulo 3: Trucos -->
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">3. "Trucos" y Filtros Comunes (Para ir m√°s r√°pido)</h2>
                    <div class="space-y-6 text-gray-700 dark:text-gray-300">
                        
                        <div>
                            <p class="mb-1"><strong><code class="code-pill">AND</code> y <code class="code-pill">OR</code> (Combinar filtros)</strong></p>
                            <p class="mb-2 text-sm">Usa <code class="code-pill">AND</code> para que se cumplan dos o m√°s condiciones. Usa <code class="code-pill">OR</code> para que se cumpla al menos una.</p>
                            <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300">... WHERE Estatus = 'Espera Interna' <span class="text-pink-400">AND</span> Dependencia = 'IMSS'</pre>
                        </div>

                        <div>
                            <p class="mb-1"><strong><code class="code-pill">LIKE</code> (Buscar texto)</strong></p>
                            <p class="mb-2 text-sm">Perfecto para buscar en la columna <code>Descripci√≥n</code> cuando no sabes el texto exacto. El <code>%</code> es un comod√≠n (significa "cualquier cosa").</p>
                            <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300">... WHERE Descripcion <span class="text-pink-400">LIKE</span> '%Homologacion%'</pre>
                        </div>

                        <div>
                            <p class="mb-1"><strong><code class="code-pill">COUNT</code> (Contar resultados)</strong></p>
                            <p class="mb-2 text-sm">En lugar de traerte todas las filas, solo te dice cu√°ntas hay. Es m√°s r√°pido.</p>
                            <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300"><span class="text-pink-400">SELECT COUNT(*) FROM</span> tabla_folios <span class="text-pink-400">WHERE</span> Estatus = 'Espera Interna'</pre>
                        </div>

                        <div class="flex items-start gap-3 p-3 bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500 rounded-r-lg">
                            <svg class="w-8 h-8 sm:w-6 sm:h-6 text-red-500 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.332-.21 3.031-1.742 3.031H4.42c-1.532 0-2.492-1.699-1.742-3.031l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            <div>
                                <p class="font-bold text-red-800 dark:text-red-200"><code class="code-pill !bg-red-100 !text-red-800 dark:!bg-red-900 dark:!text-red-200">LIMIT</code> (Comando de seguridad) ¬°MUY IMPORTANTE!</p>
                                <p class="text-red-700 dark:text-red-200 text-sm mt-1">√ösalo siempre para no saturar el sistema. Te trae solo los primeros 'X' resultados.</p>
                                <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300 mt-2">... WHERE Estatus = 'Espera Interna' <span class="text-pink-400">LIMIT</span> 10</pre>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- Fin de sql-learning-section -->

        </div> <!-- Fin de querys-page-container -->
        
        <div id="loading-indicator" class="text-center py-10"><p class="text-gray-500 dark:text-gray-400">Cargando datos...</p></div>
    </div>

    <footer class="text-center py-8 border-t border-gray-200 dark:border-gray-700">
        <p class="text-sm text-gray-500 dark:text-gray-400">
            Herramienta creada por la Gerencia de Atenci√≥n al P√∫blico - Afore Coppel
        </p>
    </footer>

    <button id="add-item-btn" class="admin-only-flex fixed bottom-8 right-8 bg-blue-700 dark:bg-yellow-400 text-white dark:text-blue-900 w-16 h-16 rounded-full shadow-lg items-center justify-center text-3xl font-bold transform hover:scale-110 transition-transform">+</button>

    <!-- Modal Gen√©rico para Agregar/Editar Items -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-blue-800 dark:text-yellow-400">Agregar Nuevo</h2>
            <form id="script-form">
                <input type="hidden" id="item-id">
                <div class="space-y-4">
                    <input type="text" id="item-title" placeholder="T√≠tulo" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="item-description" placeholder="Descripci√≥n breve" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="2"></textarea>
                    <textarea id="item-text" placeholder="Texto completo del script/query..." required class="w-full p-2 border rounded font-mono dark:bg-gray-700 dark:border-gray-600" rows="6"></textarea>
                    
                    <!-- Categor√≠as para SCRIPTS -->
                    <select id="item-category-script" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- Seleccionar Categor√≠a --</option>
                        <option value="unificacion">Unificaci√≥n/Separaci√≥n</option>
                        <option value="exp">Exp. y Serv.</option>
                        <option value="parciales">Retiros Parciales</option>
                        <option value="totales">Retiros Totales</option>
                        <option value="extras">Extras</option>
                    </select>
                    
                    <!-- Categor√≠as para QUERYS -->
                    <select id="item-category-query" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- Seleccionar Servidor --</option>
                        <option value="aforeglobal">AforeGlobal</option>
                        <option value="safre">Safre</option>
                        <option value="notificaciones">Notificaciones</option>
                        <option value="admonafore">AdmonAfore</option>
                        <option value="serviciosafore">ServiciosAfore</option>
                        <option value="extra">Extra</option>
                    </select>

                    <input type="text" id="item-variables" placeholder="Variables (separadas por coma, ej: FECHA, MONTO)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-btn" class="py-2 px-4 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Guardar</button>
                </div>
            </form>
             <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>
    
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 class="text-xl font-bold mb-4">¬øEst√°s seguro?</h2>
            <p id="delete-modal-text" class="text-gray-600 dark:text-gray-300 mb-6">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="py-2 px-6 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">No</button>
                <button id="confirm-delete-btn" class="py-2 px-6 rounded bg-red-600 text-white hover:bg-red-700">S√≠, Eliminar</button>
            </div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 id="info-modal-title" class="text-xl font-bold mb-4 text-blue-800 dark:text-yellow-400">Solicitud Enviada</h2>
            <p id="info-modal-text" class="text-gray-600 dark:text-gray-300 mb-6">Tu solicitud ha sido enviada al Super Administrador para aprobaci√≥n.</p>
            <button id="info-modal-close" class="py-2 px-6 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Entendido</button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h2 class="text-2xl font-bold mb-4 text-center text-blue-800 dark:text-yellow-400">Acceso Admin</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Correo electr√≥nico" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <input type="password" id="login-password" placeholder="Contrase√±a" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Iniciar Sesi√≥n</button>
                </div>
            </form>
            <button id="close-login-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>

    <div id="register-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h2 class="text-2xl font-bold mb-2 text-center text-blue-800 dark:text-yellow-400">Solicitar Acceso</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-6">Tu solicitud ser√° enviada al Superadministrador.</p>
            
            <form id="register-form">
                <div class="space-y-4">
                    <input type="text" id="reg-name" placeholder="Nombre Completo" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    <input type="email" id="reg-email" placeholder="Correo electr√≥nico" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    <input type="password" id="reg-password" placeholder="Contrase√±a" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    <input type="text" id="reg-area" placeholder="√Årea / Puesto" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500 font-bold transition-colors">Enviar Solicitud</button>
                </div>
            </form>
            <button id="close-reg-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>
    
    <script type="module">
       // --- IMPORTS DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, increment, getDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        // --- CONFIGURACI√ìN ---
        const firebaseConfig = {
          apiKey: "AIzaSyAvq0CF94lVwGZAtXiFZKHwS5q4ZA489lM",
          authDomain: "scripts-une-gap.firebaseapp.com",
          projectId: "scripts-une-gap",
          storageBucket: "scripts-une-gap.firebasestorage.app",
          messagingSenderId: "567975326387",
          appId: "1:567975326387:web:28edbab67668d1a829f6c6",
          measurementId: "G-GJK53TR2D6"
        };

        // --- INICIALIZACI√ìN ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- COLECCIONES ---
        const scriptsCollection = collection(db, 'scripts');
        const requestsCollection = collection(db, 'solicitudes');
        const querysCollection = collection(db, 'querys');
        const queryRequestsCollection = collection(db, 'solicitudes_querys');
        const userRolesCollection = collection(db, 'user_roles');

        // --- ESTADO GLOBAL ---
        let currentView = 'scripts';
        let isRegistering = false;
        let currentUserRole = null;
        let userId = null;
        let favorites = JSON.parse(localStorage.getItem('favoriteScripts')) || [];
        let queryFavorites = JSON.parse(localStorage.getItem('favoriteQuerys')) || [];
        const copiedScripts = new Set();
        const copiedQuerys = new Set();

        // --- DATOS ---
        let allScripts = [];
        let pendingRequests = [];
        let pendingUsers = [];
        let allQuerys = [];
        let pendingQueryRequests = [];
        
        // --- LISTENERS ---
        let unsubscribeScripts = null;
        let unsubscribeRequests = null;
        let unsubscribeQuerys = null;
        let unsubscribeQueryRequests = null;

        // --- DOM ELEMENTS ---
        const scriptsPage = document.getElementById('scripts-page-container');
        const scriptsContainer = document.getElementById('scripts-container');
        const scriptFilters = document.getElementById('category-filters');
        const scriptSearchInput = document.getElementById('search-input');
        
        const querysPage = document.getElementById('querys-page-container');
        const querysContainer = document.getElementById('querys-container');
        const queryFilters = document.getElementById('query-category-filters');
        const querySearchInput = document.getElementById('query-search-input');
        const querySearchContainer = document.getElementById('query-search-container');
        
        const learningSection = document.getElementById('sql-learning-section');
        const mainNav = document.getElementById('main-nav');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // --- DOM AUTH ---
        const authControls = document.getElementById('auth-controls');
        const registerModal = document.getElementById('register-modal');

        // --- FUNCIONES AUTH Y REGISTRO ---
        const openRegModal = () => { registerModal.classList.remove('hidden'); setTimeout(() => registerModal.classList.remove('opacity-0'), 10); };
        const closeRegModal = () => { registerModal.classList.add('opacity-0'); setTimeout(() => registerModal.classList.add('hidden'), 300); document.getElementById('register-form').reset(); };
        
        if(document.getElementById('close-reg-modal-btn')) document.getElementById('close-reg-modal-btn').addEventListener('click', closeRegModal);

        const registerForm = document.getElementById('register-form');
        if(registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const name = document.getElementById('reg-name').value;
                const area = document.getElementById('reg-area').value;

                isRegistering = true;

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    await setDoc(doc(db, "user_roles", user.uid), {
                        email: email,
                        displayName: name,
                        area: area,
                        role: 'viewer',
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });

                    closeRegModal();
                    alert("‚úÖ ¬°Solicitud enviada correctamente!\n\nTu usuario ha sido creado. Por favor espera a que el Superadministrador active tu cuenta.");
                    await signOut(auth);

                } catch (error) {
                    console.error("Error registro:", error);
                    if(error.code === 'auth/email-already-in-use') {
                        alert("Este correo ya est√° registrado. Intenta iniciar sesi√≥n.");
                    } else {
                        alert("Hubo un error: " + error.message);
                    }
                } finally {
                    isRegistering = false;
                }
            });
        }

        // --- L√ìGICA PRINCIPAL DE AUTENTICACI√ìN ---
        onAuthStateChanged(auth, async (user) => {
            if (isRegistering) return;

            // Limpiar listeners anteriores
            if (unsubscribeScripts) unsubscribeScripts();
            if (unsubscribeRequests) unsubscribeRequests();
            if (unsubscribeQuerys) unsubscribeQuerys();
            if (unsubscribeQueryRequests) unsubscribeQueryRequests();

            currentUserRole = null;
            userId = user ? user.uid : null;

            if (user) {
                console.log("Usuario detectado, verificando...");
                try {
                    const userDocRef = doc(userRolesCollection, user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        
                        if (userData.status !== 'active') {
                            await signOut(auth);
                            if (userData.status === 'pending') {
                                alert("‚è≥ Tu cuenta est√° en revisi√≥n.");
                            } else {
                                alert("‚õî Acceso denegado.");
                            }
                            return;
                        }

                        currentUserRole = userData.role;
                        
                        authControls.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="text-right hidden sm:block">
                                    <div class="text-xs font-bold text-blue-800 dark:text-yellow-400">${userData.displayName || 'Usuario'}</div>
                                    <div class="text-[10px] text-gray-500 uppercase">${currentUserRole}</div>
                                </div>
                                <button id="logout-btn" class="text-sm font-bold text-red-500 hover:text-red-700 border border-red-200 px-3 py-1 rounded hover:bg-red-50">Salir</button>
                            </div>
                        `;
                        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

                        setupAdminUI(currentUserRole);
                        setupFirestoreListeners();
                        navigateTo(currentView);

                    } else {
                        console.log("Usuario sin perfil en BD.");
                        await signOut(auth);
                        alert("‚ö†Ô∏è Usuario no encontrado en la base de datos.");
                    }
                } catch (error) {
                    console.error("Error verificando:", error);
                    await signOut(auth);
                    loadingIndicator.innerHTML = '<p class="text-red-500">Error de conexi√≥n. Recargando...</p>';
                    window.location.reload();
                }
            } else {
                // --- ESTADO: NO LOGUEADO ---
                console.log("Esperando login...");
                
                // 1. Limpiar contenido de fondo
                if(scriptsContainer) scriptsContainer.innerHTML = ''; 
                if(querysContainer) querysContainer.innerHTML = '';
                
                // 2. Limpiar barra superior (para que no estorbe)
                if(authControls) authControls.innerHTML = '';

                // 3. MOSTRAR BOTONES EN EL CENTRO (Soluci√≥n Definitiva)
                loadingIndicator.style.display = 'block';
                loadingIndicator.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-10 bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md mx-auto mt-10 border border-gray-200 dark:border-gray-700">
                                                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2 mt-4">Acceso Restringido</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-center mb-8">Esta biblioteca es exclusiva para colaboradores autorizados.</p>
                        
                        <div class="flex flex-col w-full gap-4">
                            <button id="btn-login-center" style="background-color: #2563EB;" class="w-full py-3 px-6 text-white font-bold rounded-lg shadow-lg hover:opacity-90 transition-all text-lg">
                                Iniciar Sesi√≥n
                            </button>
                            <button id="btn-register-center" style="background-color: #16A34A;" class="w-full py-3 px-6 text-white font-bold rounded-lg shadow-lg hover:opacity-90 transition-all text-lg">
                                Solicitar Acceso
                            </button>
                        </div>
                    </div>
                `;
                
                setupAdminUI(null);

                // 4. Activar los botones del centro
                const btnLogin = document.getElementById('btn-login-center');
                const btnRegister = document.getElementById('btn-register-center');

                if(btnLogin) btnLogin.addEventListener('click', openLoginModal);
                if(btnRegister) btnRegister.addEventListener('click', openRegModal);
            }
        });

        // --- CONFIGURACI√ìN DE LISTENERS (DB) ---
        const setupFirestoreListeners = () => {
            if (!auth.currentUser) return;

            if (unsubscribeScripts) unsubscribeScripts();
            if (unsubscribeQuerys) unsubscribeQuerys();
            if (unsubscribeRequests) unsubscribeRequests();
            
            loadingIndicator.style.display = 'block';
            loadingIndicator.innerText = "Cargando datos...";

            // 1. Scripts
            unsubscribeScripts = onSnapshot(scriptsCollection, (snapshot) => {
                allScripts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'scripts') applyScriptFilters();
                loadingIndicator.style.display = 'none';
            }, (error) => {
                console.error("Error scripts:", error);
                if (error.code === 'permission-denied') {
                     loadingIndicator.innerHTML = `<div class="text-red-500 text-center p-10 font-bold bg-white rounded-lg shadow">‚ö†Ô∏è No tienes permisos.</div>`;
                }
            });

            // 2. Querys
            unsubscribeQuerys = onSnapshot(querysCollection, (snapshot) => {
                allQuerys = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'querys') applyQueryFilters();
            }, (error) => console.log("Querys:", error.message));

            // 3. Solicitudes (Superadmin)
            if (currentUserRole === 'superadmin') {
                 unsubscribeRequests = onSnapshot(requestsCollection, (snapshot) => {
                     pendingRequests = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                     if (currentView === 'scripts' && scriptFilters.querySelector('.active').dataset.category === 'requests') renderCombinedRequests();
                 });

                 onSnapshot(userRolesCollection, (snapshot) => {
                     pendingUsers = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(user => user.status === 'pending');
                     if (currentView === 'scripts' && scriptFilters.querySelector('.active').dataset.category === 'requests') renderCombinedRequests();
                 });
            }
        };

        // --- FILTROS ---
        const applyScriptFilters = () => {
             if (!scriptsContainer) return;
             const searchTerm = scriptSearchInput.value.toLowerCase();
             const activeCategory = scriptFilters.querySelector('.active').dataset.category;
             
             if (activeCategory === 'requests') {
                 renderCombinedRequests(); 
                 return;
             }

             let filtered = allScripts;
             if (activeCategory === 'favorites') filtered = allScripts.filter(s => favorites.includes(s.id));
             else if (activeCategory === 'popular') filtered = [...allScripts].sort((a,b) => (b.copyCount||0) - (a.copyCount||0));
             else if (activeCategory !== 'all') filtered = allScripts.filter(s => s.category === activeCategory);
             
             if (searchTerm) filtered = filtered.filter(s => s.title.toLowerCase().includes(searchTerm) || s.description.toLowerCase().includes(searchTerm));
             
             renderScripts(filtered);
        };

        const applyQueryFilters = () => {
             if (!querysContainer) return;
             const searchTerm = querySearchInput.value.toLowerCase();
             const activeCategory = queryFilters.querySelector('.active').dataset.category;
             let filtered = allQuerys;

             if (activeCategory === 'favorites') filtered = allQuerys.filter(q => queryFavorites.includes(q.id));
             else if (activeCategory === 'popular') filtered = [...allQuerys].sort((a,b) => (b.copyCount||0) - (a.copyCount||0));
             else if (activeCategory !== 'all' && activeCategory !== 'learn') filtered = allQuerys.filter(q => q.category === activeCategory);
             
             if (searchTerm) filtered = filtered.filter(q => q.title.toLowerCase().includes(searchTerm) || q.description.toLowerCase().includes(searchTerm));
             
             renderQuerys(filtered);
        };

        // --- RENDERIZADO DE SOLICITUDES ---
        const renderCombinedRequests = () => {
            if(!scriptsContainer) return;
            scriptsContainer.innerHTML = '';
            
            if (pendingUsers.length === 0 && pendingRequests.length === 0) {
                scriptsContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No hay solicitudes pendientes.</p>`;
                return;
            }

            pendingUsers.forEach(user => {
                const card = document.createElement('div');
                card.className = 'relative bg-blue-50 dark:bg-slate-800 border-2 border-blue-200 dark:border-blue-900 rounded-xl shadow-lg overflow-hidden flex flex-col mb-4';
                card.innerHTML = `
                    <div class="absolute top-2 right-2 px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded-full">SOLICITUD ACCESO</div>
                    <div class="p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-1">${user.displayName || 'Sin Nombre'}</h2>
                        <p class="text-blue-600 dark:text-blue-400 font-mono text-sm mb-2">${user.email}</p>
                        <p class="text-gray-600 dark:text-gray-300 text-sm"><strong>√Årea:</strong> ${user.area || 'N/A'}</p>
                        <p class="text-gray-500 dark:text-gray-400 text-xs mt-2">Fecha: ${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'Reciente'}</p>
                    </div>
                    <div class="p-4 bg-blue-100 dark:bg-slate-700/50 border-t border-blue-200 dark:border-blue-900 mt-auto flex gap-2">
                        <button data-userid="${user.id}" class="reject-user-btn w-1/2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Rechazar</button>
                        <button data-userid="${user.id}" class="approve-user-btn w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Aprobar</button>
                    </div>`;
                scriptsContainer.appendChild(card);
            });

            pendingRequests.forEach(request => {
                const req = request.data;
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden flex flex-col';
                let color = req.action === 'add' ? 'bg-green-500' : (req.action === 'delete' ? 'bg-red-500' : 'bg-yellow-500');
                let text = req.action === 'add' ? 'NUEVO' : (req.action === 'delete' ? 'ELIMINAR' : 'EDITAR');
                
                card.innerHTML = `
                    <div class="absolute top-2 right-2 px-2 py-1 ${color} text-white text-xs font-bold rounded-full">${text}</div>
                    <div class="p-6">
                        <h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2">${req.title}</h2>
                        <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${req.description}</p>
                        <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm overflow-y-auto max-h-48"><pre class="font-sans">${req.scriptText}</pre></div>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 mt-auto flex gap-2">
                        <button data-id="${request.id}" class="reject-btn w-1/2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Rechazar</button>
                        <button data-id="${request.id}" class="approve-btn w-1/2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Aprobar</button>
                    </div>`;
                scriptsContainer.appendChild(card);
            });
        };

        // --- RENDERIZADO DE CARDS (SCRIPTS/QUERYS) ---
        const renderScripts = (scriptsToRender) => {
            if(!scriptsContainer) return;
            scriptsContainer.innerHTML = '';
            if (scriptsToRender.length === 0) {
                scriptsContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No se encontraron resultados.</p>`;
                return;
            }
            const activeCategory = scriptFilters.querySelector('.active').dataset.category;
            const isPopularView = activeCategory === 'popular';
            
            scriptsToRender.forEach((script, index) => {
                const isFavorite = favorites.includes(script.id);
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 ease-in-out flex flex-col card-enter';
                card.style.animationDelay = `${index * 50}ms`;
                
                let popularBadgeHtml = '';
                if (isPopularView) {
                    const count = script.copyCount || 0;
                    popularBadgeHtml = `<div class="absolute top-3 right-20 flex items-center gap-1 text-xs bg-red-100 text-red-800 dark:bg-orange-900 dark:text-orange-300 px-2 py-1 rounded-full font-semibold z-10">üî• <span>${count}</span></div>`;
                }

                let favoriteBtnHtml = '';
                if (!isPopularView) {
                    favoriteBtnHtml = `<button class="favorite-btn absolute top-2 right-2 p-1 text-gray-400 hover:text-yellow-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="${isFavorite ? 'text-yellow-400' : 'text-gray-400/60'}" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg></button>`;
                }
                
                let variablesHtml = '';
                if (script.variables && script.variables.length > 0) {
                    const variableInputs = script.variables.map(v => `<div class="flex items-center gap-2"><label class="text-sm font-mono text-gray-600 dark:text-gray-300 w-1/3 truncate">${v}:</label><input type="text" data-variable-name="${v}" class="variable-input w-2/3 p-1 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"></div>`).join('');
                    variablesHtml = `<div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-3"><h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">Variables:</h4><div class="space-y-2">${variableInputs}</div></div>`;
                }

                let adminOptionsHtml = `<div class="admin-only-flex absolute top-2 right-10 z-10"><button class="options-btn p-1 text-gray-400 hover:text-blue-700 dark:hover:text-yellow-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg></button><div class="options-menu absolute right-0 mt-8 w-40 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 hidden z-20"><a href="#" class="edit-btn block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100">Modificar</a><a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Eliminar</a></div></div>`;

                card.innerHTML = `${popularBadgeHtml} ${adminOptionsHtml} <div class="p-6 flex-grow"><div class="flex justify-between items-start"><h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2 pr-20">${script.title}</h2>${favoriteBtnHtml}</div><p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${script.description}</p><div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm max-h-48 overflow-y-auto"><pre class="script-content font-sans">${script.scriptText}</pre></div>${variablesHtml}</div><div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700"><button class="copy-btn w-full bg-yellow-400 text-blue-800 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-yellow-500"><span>Copiar Script</span></button></div>`;
                card.dataset.id = script.id;
                card.dataset.type = 'scripts';
                scriptsContainer.appendChild(card);
                
                if (copiedScripts.has(script.id)) {
                     const btn = card.querySelector('.copy-btn');
                     if(btn) { btn.classList.add('copied'); btn.innerHTML = '<span>¬°Copiado!</span>'; }
                }
            });
        };

        const renderQuerys = (querysToRender) => {
            if(!querysContainer) return;
            querysContainer.innerHTML = '';
            if (querysToRender.length === 0) {
                querysContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No se encontraron resultados.</p>`;
                return;
            }
            const activeCategory = queryFilters.querySelector('.active').dataset.category;
            const isPopularView = activeCategory === 'popular';
            const serverNames = { 'aforeglobal': 'AforeGlobal', 'safre': 'Safre', 'notificaciones': 'Notificaciones', 'admonafore': 'AdmonAfore', 'serviciosafore': 'ServiciosAfore', 'extra': 'Extra' };
            
            querysToRender.forEach((query, index) => {
                const isFavorite = queryFavorites.includes(query.id);
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 ease-in-out flex flex-col card-enter';
                card.style.animationDelay = `${index * 50}ms`;

                let popularBadgeHtml = '';
                if (isPopularView) {
                    const count = query.copyCount || 0;
                    popularBadgeHtml = `<div class="absolute top-3 right-20 flex items-center gap-1 text-xs bg-red-100 text-red-800 dark:bg-orange-900 dark:text-orange-300 px-2 py-1 rounded-full font-semibold z-10">üî• <span>${count}</span></div>`;
                }
                
                let favoriteBtnHtml = '';
                if (!isPopularView) {
                    favoriteBtnHtml = `<button class="favorite-btn absolute top-2 right-2 p-1 text-gray-400 hover:text-yellow-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="${isFavorite ? 'text-yellow-400' : 'text-gray-400/60'}" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg></button>`;
                }
                
                let serverBadgeHtml = '';
                const serverName = serverNames[query.category];
                if (serverName) {
                    serverBadgeHtml = `<div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-3"><h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">Servidor:</h4><span class="font-mono font-bold text-gray-800 dark:text-gray-200 text-sm">${serverName}</span></div>`;
                }

                let adminOptionsHtml = `<div class="admin-only-flex absolute top-2 right-10 z-10"><button class="options-btn p-1 text-gray-400 hover:text-blue-700 dark:hover:text-yellow-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg></button><div class="options-menu absolute right-0 mt-8 w-40 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 hidden z-20"><a href="#" class="edit-btn block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100">Modificar</a><a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Eliminar</a></div></div>`;

                card.innerHTML = `${popularBadgeHtml} ${adminOptionsHtml} <div class="p-6 flex-grow"><div class="flex justify-between items-start"><h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2 pr-20">${query.title}</h2>${favoriteBtnHtml}</div><p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${query.description}</p><div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm max-h-32 overflow-y-auto"><pre class="script-content font-mono">${query.scriptText}</pre></div>${serverBadgeHtml}</div><div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700"><button class="copy-btn w-full bg-yellow-400 text-blue-800 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-yellow-500"><span>Copiar Query</span></button></div>`;
                card.dataset.id = query.id;
                card.dataset.type = 'query';
                querysContainer.appendChild(card);
                
                if (copiedQuerys.has(query.id)) {
                     const btn = card.querySelector('.copy-btn');
                     if(btn) { btn.classList.add('copied'); btn.innerHTML = '<span>¬°Copiado!</span>'; }
                }
            });
        };

        const navigateTo = (view) => {
            currentView = view;
            if (view === 'scripts') {
                scriptsPage.classList.remove('hidden');
                querysPage.classList.add('hidden');
                mainNav.querySelector('[data-view="scripts"]').classList.add('active');
                mainNav.querySelector('[data-view="querys"]').classList.remove('active');
                applyScriptFilters();
            } else {
                scriptsPage.classList.add('hidden');
                querysPage.classList.remove('hidden');
                mainNav.querySelector('[data-view="scripts"]').classList.remove('active');
                mainNav.querySelector('[data-view="querys"]').classList.add('active');
                
                const cat = queryFilters.querySelector('.active').dataset.category;
                if(cat === 'learn') {
                    querysContainer.classList.add('hidden');
                    learningSection.classList.remove('hidden');
                } else {
                    querysContainer.classList.remove('hidden');
                    learningSection.classList.add('hidden');
                    applyQueryFilters();
                }
            }
        };

        // --- EVENT LISTENERS GLOBALES ---
        document.getElementById('app-container').addEventListener('click', async (e) => {
            // --- APROBACI√ìN DE USUARIOS ---
            if (e.target.closest('.approve-user-btn')) {
                const uid = e.target.closest('.approve-user-btn').dataset.userid;
                if(confirm('¬øAprobar acceso a este usuario?')) {
                    await updateDoc(doc(userRolesCollection, uid), { status: 'active', role: 'viewer' });
                    alert("Usuario aprobado con √©xito.");
                }
                return;
            }
            if (e.target.closest('.reject-user-btn')) {
                const uid = e.target.closest('.reject-user-btn').dataset.userid;
                if(confirm('¬øRechazar y eliminar solicitud?')) {
                    await deleteDoc(doc(userRolesCollection, uid));
                    alert("Solicitud rechazada y eliminada.");
                }
                return;
            }
            
            const card = e.target.closest('[data-id]');
            if (!card) return;
            const id = card.dataset.id;
            const type = card.dataset.type;
            
            // Copy
            if (e.target.closest('.copy-btn')) {
                 const content = card.querySelector('.script-content').textContent;
                 navigator.clipboard.writeText(content).then(() => {
                     const collection = type === 'scripts' ? scriptsCollection : querysCollection;
                     const set = type === 'scripts' ? copiedScripts : copiedQuerys;
                     const render = type === 'scripts' ? applyScriptFilters : applyQueryFilters;
                     
                     updateDoc(doc(collection, id), { copyCount: increment(1) });
                     set.add(id);
                     render();
                     setTimeout(() => { set.delete(id); render(); }, 2000);
                 });
            }
            
            // Favorite
            if (e.target.closest('.favorite-btn')) {
                const list = type === 'scripts' ? favorites : queryFavorites;
                const key = type === 'scripts' ? 'favoriteScripts' : 'favoriteQuerys';
                const render = type === 'scripts' ? applyScriptFilters : applyQueryFilters;
                
                const idx = list.indexOf(id);
                if(idx > -1) list.splice(idx, 1); else list.push(id);
                localStorage.setItem(key, JSON.stringify(list));
                render();
            }
            
            // Options
            if (e.target.closest('.options-btn')) {
                e.target.closest('.options-btn').nextElementSibling.classList.toggle('hidden');
            }
            if (e.target.closest('.edit-btn')) {
                e.preventDefault();
                handleEditClick(id, type);
            }
            if (e.target.closest('.delete-btn')) {
                e.preventDefault();
                handleDeleteClick(id, type);
            }
        });

        // --- L√ìGICA DE ADMINISTRACI√ìN ---
        const itemModal = document.getElementById('add-item-modal');
        const itemForm = document.getElementById('script-form');
        const modalTitle = document.getElementById('modal-title');
        const itemIdInput = document.getElementById('item-id');
        const deleteModal = document.getElementById('delete-confirm-modal');
        const deleteModalText = document.getElementById('delete-modal-text');
        let itemToDelete = null;

        document.getElementById('add-item-btn').addEventListener('click', () => {
            modalTitle.textContent = currentView === 'scripts' ? 'Agregar Nuevo Script' : 'Agregar Nueva Query';
            itemForm.reset();
            itemIdInput.value = '';
            
            const scriptCat = document.getElementById('item-category-script');
            const queryCat = document.getElementById('item-category-query');
            const varsInput = document.getElementById('item-variables');

            if (currentView === 'scripts') {
                scriptCat.classList.remove('hidden'); scriptCat.required = true;
                queryCat.classList.add('hidden'); queryCat.required = false;
                varsInput.classList.remove('hidden');
            } else {
                scriptCat.classList.add('hidden'); scriptCat.required = false;
                queryCat.classList.remove('hidden'); queryCat.required = true;
                varsInput.classList.add('hidden');
            }
            itemModal.classList.remove('hidden');
            setTimeout(() => itemModal.classList.remove('opacity-0'), 10);
        });

        const closeItemModal = () => {
            itemModal.classList.add('opacity-0');
            setTimeout(() => itemModal.classList.add('hidden'), 300);
        };
        document.getElementById('cancel-btn').addEventListener('click', closeItemModal);
        document.getElementById('close-modal-btn').addEventListener('click', closeItemModal);

        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = itemIdInput.value;
            const isEdit = !!id;
            const collectionRef = currentView === 'scripts' ? scriptsCollection : querysCollection;
            const requestsRef = currentView === 'scripts' ? requestsCollection : queryRequestsCollection;
            
            const data = {
                title: document.getElementById('item-title').value,
                description: document.getElementById('item-description').value,
                scriptText: document.getElementById('item-text').value,
                category: currentView === 'scripts' ? document.getElementById('item-category-script').value : document.getElementById('item-category-query').value,
                variables: currentView === 'scripts' ? document.getElementById('item-variables').value.split(',').map(v=>v.trim()).filter(v=>v) : [],
                updatedAt: serverTimestamp(),
                lastUpdatedBy: auth.currentUser.uid
            };

            try {
                if (currentUserRole === 'superadmin') {
                    if (isEdit) await updateDoc(doc(collectionRef, id), data);
                    else { data.copyCount = 0; await addDoc(collectionRef, data); }
                    alert(isEdit ? "Actualizado correctamente" : "Creado correctamente");
                } else {
                    await addDoc(requestsRef, { ...data, action: isEdit ? 'edit' : 'add', originalId: id || null, status: 'pending', requestedBy: auth.currentUser.uid, timestamp: serverTimestamp() });
                    alert("Solicitud enviada al Superadministrador.");
                }
                closeItemModal();
            } catch (error) {
                console.error("Error al guardar:", error);
                alert("Error: " + error.message);
            }
        });

        const handleEditClick = (id, type) => {
            const list = type === 'scripts' ? allScripts : allQuerys;
            const item = list.find(i => i.id === id);
            if (!item) return;

            itemIdInput.value = id;
            document.getElementById('item-title').value = item.title;
            document.getElementById('item-description').value = item.description;
            document.getElementById('item-text').value = item.scriptText;
            
            if (type === 'scripts') {
                document.getElementById('item-category-script').value = item.category;
                document.getElementById('item-variables').value = (item.variables || []).join(', ');
                document.getElementById('item-category-script').classList.remove('hidden');
                document.getElementById('item-category-query').classList.add('hidden');
            } else {
                document.getElementById('item-category-query').value = item.category;
                document.getElementById('item-category-script').classList.add('hidden');
                document.getElementById('item-category-query').classList.remove('hidden');
            }
            
            modalTitle.textContent = 'Modificar Elemento';
            itemModal.classList.remove('hidden');
            setTimeout(() => itemModal.classList.remove('opacity-0'), 10);
        };

        const handleDeleteClick = (id, type) => {
            itemToDelete = { id, type };
            const list = type === 'scripts' ? allScripts : allQuerys;
            const item = list.find(i => i.id === id);
            deleteModalText.textContent = currentUserRole === 'superadmin' ? `¬øEliminar "${item.title}" permanentemente?` : `¬øSolicitar eliminar "${item.title}"?`;
            deleteModal.classList.remove('hidden');
            setTimeout(() => deleteModal.classList.remove('opacity-0'), 10);
        };

        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
             deleteModal.classList.add('opacity-0');
             setTimeout(() => deleteModal.classList.add('hidden'), 300);
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (!itemToDelete) return;
            const { id, type } = itemToDelete;
            const collectionRef = type === 'scripts' ? scriptsCollection : querysCollection;
            try {
                if (currentUserRole === 'superadmin') {
                    await deleteDoc(doc(collectionRef, id));
                    alert("Eliminado correctamente");
                } else {
                    const requestsRef = type === 'scripts' ? requestsCollection : queryRequestsCollection;
                    const list = type === 'scripts' ? allScripts : allQuerys;
                    const item = list.find(i => i.id === id);
                    await addDoc(requestsRef, { originalId: id, title: item.title, action: 'delete', status: 'pending', requestedBy: auth.currentUser.uid, timestamp: serverTimestamp() });
                    alert("Solicitud de eliminaci√≥n enviada.");
                }
                deleteModal.classList.add('opacity-0');
                setTimeout(() => deleteModal.classList.add('hidden'), 300);
            } catch (e) {
                console.error(e);
                alert("Error al eliminar");
            }
        });
    </script>
</body>
</html>

































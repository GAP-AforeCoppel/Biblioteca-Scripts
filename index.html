<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca de Scripts CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #1d4ed8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #1e40af; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #fbbF24; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
        .script-content { white-space: pre-wrap; word-wrap: break-word; }
        .nav-button.active { background-color: #1d4ed8; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark .nav-button.active { background-color: #fbbF24; color: #111827; }
        #add-item-modal, #delete-confirm-modal, #login-modal, #info-modal { transition: opacity 0.3s ease; }
        
        /* Reglas de visibilidad para Admin */
        .admin-only-flex { display: none !important; }
        body.admin-mode .admin-only-flex { display: flex !important; }

        /* Estilo para el bot√≥n de copiar confirmado */
        .copy-btn.copied {
            background-color: #16a34a !important; /* Verde brillante (Tailwind green-600) */
            color: white !important;
        }
        .copy-btn.copied:hover {
            background-color: #15803d !important; /* Tono m√°s oscuro al pasar el mouse (green-700) */
        }

        /* Animaci√≥n de entrada para tarjetas */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; }
        }
        .card-enter {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Estilos para el Navegador Principal de Pesta√±as */
        .main-nav-btn {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .main-nav-btn.active {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .dark .main-nav-btn.active {
            background-color: #fbbF24; /* yellow-400 */
            color: #111827; /* gray-900 */
        }
        
        /* Estilo para las p√≠ldoras de c√≥digo en la secci√≥n de aprendizaje */
        .code-pill {
            background-color: #dbeafe; /* blue-100 */
            color: #1e40af; /* blue-800 */
            font-family: monospace;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.125rem 0.5rem; /* px-2 py-0.5 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
        }
        .dark .code-pill {
            background-color: #374151; /* gray-700 */
            color: #93c5fd; /* blue-300 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 transition-colors duration-300">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <div class="flex justify-between items-center py-4 px-2 mb-6">
            <div class="flex items-center gap-4">
                <img src="logoafore.png" alt="Logo Afore Coppel" class="h-14" onerror="this.alt='Logo Afore Coppel'; this.style.display='none';">
                <div class="border-l border-gray-300 dark:border-gray-600 h-14"></div>
                <img src="logogap.png" alt="Logo Gerencia de Atenci√≥n al P√∫blico" class="w-24" onerror="this.alt='Logo Gerencia'; this.style.display='none';">
            </div>
            <div class="flex items-center gap-4">
                <div id="auth-controls"></div>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                    <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>

        <!-- =========== NAVEGACI√ìN PRINCIPAL (SCRIPTS/QUERYS) =========== -->
        <div id="main-nav" class="flex flex-wrap justify-center gap-4 mb-8">
            <button data-view="scripts" class="main-nav-btn active flex items-center gap-2 font-medium py-3 px-6 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zM6.028 3.85a.5.5 0 0 1 .5-.5h2.944a.5.5 0 0 1 .5.5v.35c0 .34-.14.66-.38.89l-1.2 1.196a.5.5 0 0 0-.14.34V8.5a.5.5 0 0 1-1 0V6.626a.5.5 0 0 0-.14-.34L6.409 5.09a.5.5 0 0 1-.38-.89v-.35zM4 11.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z"/><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H4z"/></svg>
                Scripts
            </button>
            <button data-view="querys" class="main-nav-btn flex items-center gap-2 font-medium py-3 px-6 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.026a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V1.026zM5 1.526v3.448h6V1.526H5z"/><path d="M12.5 6a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V6.5a.5.5 0 0 1 .5-.5h7zM5 6.526v3.448h6V6.526H5z"/><path d="M4 11.026a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V11.026zM5 11.526v3.448h6v-3.448H5z"/></svg>
                Querys
            </button>
        </div>

        <!-- =========== CONTENEDOR DE P√ÅGINA DE SCRIPTS =========== -->
        <div id="scripts-page-container">
            <header class="relative text-center mb-8 bg-cover bg-center rounded-lg shadow-lg overflow-hidden py-40" style="background-image: url('cafe.png'); background-color: #2c3e50;">
                <div class="absolute inset-0 bg-blue-900 bg-opacity-50"></div>
                <div class="relative z-10">
                    <h1 id="script-page-title" class="text-4xl sm:text-5xl font-bold text-white dark:text-yellow-300">Biblioteca de Scripts</h1>
                    <p id="script-page-slogan" class="text-lg text-gray-200 dark:text-gray-300 mt-2">Soluciones r√°pidas para casos de CRM en Salesforce</p>
                </div>
            </header>

            <div class="mb-8 max-w-2xl mx-auto">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                         <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="text" id="search-input" class="block w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-full py-3 pl-10 pr-4 text-gray-900 dark:text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-yellow-500 transition" placeholder="Buscar por t√≠tulo o descripci√≥n...">
                </div>
            </div>

            <nav id="category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button data-category="all" class="nav-button active font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Todos</button>
                <button data-category="requests" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md admin-only-flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-inbox" viewBox="0 0 16 16"><path d="M4.38 1C3.242 1 2.22 1.8 2.034 2.818L.03 10.873A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.47-2.127L13.966 2.818A2 2 0 0 0 11.62 1H4.38zM1 2.81C1.002 2.7 1 2.58 1 2.5a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1c0 .08-.002.199-.034.31L13.06 10.37A.5.5 0 0 1 12.5 10.5h-11a.5.5 0 0 1-.56-.37L1 2.81zm13.38 9.19-2.75-2.75a.5.5 0 0 0-.707 0L8 12.207l-1.42-1.42a.5.5 0 0 0-.707 0L3.12 13.5H1.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1h-1.12z"/></svg>
                    Solicitudes
                    <span id="requests-count-badge" class="hidden ml-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full items-center justify-center">0</span>
                </button>
                <button data-category="favorites" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">‚òÖ Favoritos</button>
                <button data-category="popular" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">üî• Populares</button>
                <button data-category="unificacion" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Unificaci√≥n/Separaci√≥n</button>
                <button data-category="exp" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Exp. y Serv.</button>
                <button data-category="parciales" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Retiros Parciales</button>
                <button data-category="totales" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Retiros Totales</button>
                <button data-category="extras" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Extras</button>
            </nav>
            
            <main id="scripts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
        </div>

        <!-- =========== CONTENEDOR DE P√ÅGINA DE QUERYS =========== -->
        <div id="querys-page-container" class="hidden">
            <header class="relative text-center mb-8 bg-cover bg-center rounded-lg shadow-lg overflow-hidden py-40" style="background-image: url('cafe.png'); background-color: #2c3e50;"> <!-- Color de fallback -->
                <div class="absolute inset-0 bg-blue-900 bg-opacity-50"></div>
                <div class="relative z-10">
                    <h1 id="query-page-title" class="text-4xl sm:text-5xl font-bold text-white dark:text-yellow-300">Biblioteca de Querys</h1>
                    <p id="query-page-slogan" class="text-lg text-gray-200 dark:text-gray-300 mt-2">Consultas optimizadas para el an√°lisis de datos</p>
                </div>
            </header>

            <div id="query-search-container" class="mb-8 max-w-2xl mx-auto">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                         <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="text" id="query-search-input" class="block w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-full py-3 pl-10 pr-4 text-gray-900 dark:text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-yellow-500 transition" placeholder="Buscar por t√≠tulo o descripci√≥n...">
                </div>
            </div>

            <nav id="query-category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button data-category="all" class="nav-button active font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Todos</button>
                <button data-category="requests" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md admin-only-flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-inbox" viewBox="0 0 16 16"><path d="M4.38 1C3.242 1 2.22 1.8 2.034 2.818L.03 10.873A1.5 1.5 0 0 0 1.5 13h13a1.5 1.5 0 0 0 1.47-2.127L13.966 2.818A2 2 0 0 0 11.62 1H4.38zM1 2.81C1.002 2.7 1 2.58 1 2.5a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1c0 .08-.002.199-.034.31L13.06 10.37A.5.5 0 0 1 12.5 10.5h-11a.5.5 0 0 1-.56-.37L1 2.81zm13.38 9.19-2.75-2.75a.5.5 0 0 0-.707 0L8 12.207l-1.42-1.42a.5.5 0 0 0-.707 0L3.12 13.5H1.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1h-1.12z"/></svg>
                    Solicitudes
                    <span id="query-requests-count-badge" class="hidden ml-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full items-center justify-center">0</span>
                </button>
                <button data-category="favorites" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">‚òÖ Favoritos</button>
                <button data-category="popular" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">üî• Populares</button>
                <button data-category="aforeglobal" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">AforeGlobal</button>
                <button data-category="safre" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Safre</button>
                <button data-category="notificaciones" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Notificaciones</button>
                <button data-category="admonafore" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">AdmonAfore</button>
                <button data-category="serviciosafore" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">ServiciosAfore</button>
                <button data-category="extra" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md">Extra</button>
                <button data-category="learn" class="nav-button font-medium py-2 px-4 rounded-full transition-all duration-300 ease-in-out hover:bg-blue-700 hover:text-white dark:hover:bg-yellow-500 dark:hover:text-gray-900 hover:shadow-md flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-book" viewBox="0 0 16 16">
                      <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.893V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.746c-.917-.432-2.107-.773-3.287-.893-1.093-.11-2.278-.06-3.213.493V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                    </svg>
                    Aprende SQL
                </button>
            </nav>
            
            <!-- Contenedor de las tarjetas de querys (se oculta) -->
            <main id="querys-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>

            <!-- M√ìDULO DE APRENDIZAJE MOVIDO AQU√ç (oculto por defecto) -->
            <div id="sql-learning-section" class="hidden">
                <!-- M√≥dulo 1: Conceptos -->
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">1. Conceptos Clave (¬øQu√© es esto?)</h2>
                    <div class="space-y-5 text-gray-700 dark:text-gray-300">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-blue-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <p><strong>¬øQu√© es un Query?</strong> Es simplemente una pregunta o "consulta" que le hacemos a la base de datos para que nos traiga informaci√≥n espec√≠fica.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-blue-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <p><strong>¬øQu√© es SQL?</strong> Es el idioma que usamos para escribir esa pregunta. (Significa "Lenguaje de Consulta Estructurada").</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-green-500 shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <p><strong>La Analog√≠a de Excel (Para entender la BD):</strong> Piensa en la base de datos como un archivo de Excel gigante.</p>
                        </div>
                        <div class="ml-10 p-4 border-l-2 border-gray-200 dark:border-gray-600 space-y-2">
                            <p class="font-semibold"><strong>Servidor:</strong> Es el archivo .xlsx completo.</p>
                            <p class="ml-4 font-semibold"><strong>Tabla:</strong> Es una hoja o pesta√±a (ej. "Folios").</p>
                            <p class="ml-8 font-semibold"><strong>Valores:</strong> Son las celdas de esa hoja.</p>
                        </div>
                    </div>
                </div>
                <!-- M√≥dulo 2: F√≥rmula M√°gica -->
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">2. La F√≥rmula M√°gica (C√≥mo LEER un Query)</h2>
                    <div class="space-y-4 text-gray-700 dark:text-gray-300">
                        <p>Casi todos los querys de consulta que usaremos se leen con esta f√≥rmula de 3 partes. Pasa el mouse sobre las palabras clave para ver qu√© hacen.</p>
                        
                        <!-- Bloque de C√≥digo Interactivo -->
                        <div id="interactive-sql-block" class="bg-gray-900 dark:bg-black/50 rounded-lg p-4 font-mono text-gray-300">
                            <span data-hover-target="exp-select" class="text-pink-400 font-bold cursor-pointer hover:underline">SELECT</span>
                            <span data-hover-target="exp-all" class_base="text-gray-300" class="text-gray-300 cursor-pointer hover:underline"> * </span>
                            <span data-hover-target="exp-from" class="text-pink-400 font-bold cursor-pointer hover:underline">FROM</span>
                            <span data-hover-target="exp-table" class_base="text-green-400" class="text-green-400 cursor-pointer hover:underline"> tabla_folios_salesforce</span>
                            <br>
                            <span data-hover-target="exp-where" class="text-pink-400 font-bold cursor-pointer hover:underline">WHERE</span>
                            <span data-hover-target="exp-condition" class_base="text-blue-300" class="text-blue-300 cursor-pointer hover:underline"> NSS = '123456789'</span>;
                        </div>
                        
                        <!-- Caja de Explicaci√≥n -->
                        <div id="sql-explanation-box" class="p-3 bg-blue-50 dark:bg-gray-700 rounded-lg text-blue-800 dark:text-blue-200 min-h-[80px] transition-all">
                            <p id="exp-default" class="sql-explanation text-gray-500 dark:text-gray-400">Pasa el mouse sobre las partes del query para ver qu√© hacen.</p>
                            <p id="exp-select" class="sql-explanation hidden font-medium"><strong>1. SELECT (El "Qu√©"):</strong> Elige qu√© columnas quieres ver. <br><code>SELECT Folio, Estatus</code> significa "Selecciona solo esas dos columnas".</p>
                            <p id="exp-all" class="sql-explanation hidden font-medium"><strong>El Asterisco (*):</strong> Es un comod√≠n que significa "TODO". <br><code>SELECT *</code> es la forma r√°pida de decir "Tr√°eme todas las columnas de la tabla".</p>
                            <p id="exp-from" class="sql-explanation hidden font-medium"><strong>2. FROM (El "D√≥nde"):</strong> Indica de qu√© tabla (u 'hoja de Excel') quieres sacar los datos.</p>
                            <p id="exp-table" class="sql-explanation hidden font-medium"><strong>Nombre de la Tabla:</strong> El lugar espec√≠fico de donde vienen los datos. En tu analog√≠a, es el nombre de la "hoja de Excel".</p>
                            <p id="exp-where" class="sql-explanation hidden font-medium"><strong>3. WHERE (El "Filtro"):</strong> La condici√≥n para filtrar. ¬°Esta es la parte m√°s importante para el diagn√≥stico!</p>
                            <p id="exp-condition" class="sql-explanation hidden font-medium"><strong>La Condici√≥n:</strong> La regla que deben cumplir las filas para ser seleccionadas. <br>Ej: <code>NSS = '123456789'</code> o <code>Numero_del_caso = '00654321'</code>.</p>
                        </div>
                    </div>
                </div>
                <!-- M√≥dulo 3: Trucos -->
                <div class="mb-6 p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-800 dark:text-yellow-400 mb-6">3. "Trucos" y Filtros Comunes (Para ir m√°s r√°pido)</h2>
                    <div class="space-y-6 text-gray-700 dark:text-gray-300">
                        
                        <div>
                            <p class="mb-1"><strong><code class="code-pill">AND</code> y <code class="code-pill">OR</code> (Combinar filtros)</strong></p>
                            <p class="mb-2 text-sm">Usa <code class="code-pill">AND</code> para que se cumplan dos o m√°s condiciones. Usa <code class="code-pill">OR</code> para que se cumpla al menos una.</p>
                            <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300">... WHERE Estatus = 'Espera Interna' <span class="text-pink-400">AND</span> Dependencia = 'IMSS'</pre>
                        </div>

                        <div>
                            <p class="mb-1"><strong><code class="code-pill">LIKE</code> (Buscar texto)</strong></p>
                            <p class="mb-2 text-sm">Perfecto para buscar en la columna <code>Descripci√≥n</code> cuando no sabes el texto exacto. El <code>%</code> es un comod√≠n (significa "cualquier cosa").</p>
                            <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300">... WHERE Descripcion <span class="text-pink-400">LIKE</span> '%Homologacion%'</pre>
                        </div>

                        <div>
                            <p class="mb-1"><strong><code class="code-pill">COUNT</code> (Contar resultados)</strong></p>
                            <p class="mb-2 text-sm">En lugar de traerte todas las filas, solo te dice cu√°ntas hay. Es m√°s r√°pido.</p>
                            <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300"><span class="text-pink-400">SELECT COUNT(*) FROM</span> tabla_folios <span class="text-pink-400">WHERE</span> Estatus = 'Espera Interna'</pre>
                        </div>

                        <div class="flex items-start gap-3 p-3 bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500 rounded-r-lg">
                            <svg class="w-8 h-8 sm:w-6 sm:h-6 text-red-500 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.332-.21 3.031-1.742 3.031H4.42c-1.532 0-2.492-1.699-1.742-3.031l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            <div>
                                <p class="font-bold text-red-800 dark:text-red-200"><code class="code-pill !bg-red-100 !text-red-800 dark:!bg-red-900 dark:!text-red-200">LIMIT</code> (Comando de seguridad) ¬°MUY IMPORTANTE!</p>
                                <p class="text-red-700 dark:text-red-200 text-sm mt-1">√ösalo siempre para no saturar el sistema. Te trae solo los primeros 'X' resultados.</p>
                                <pre class="bg-gray-900 dark:bg-black/50 p-2 rounded-md font-mono text-xs text-gray-300 mt-2">... WHERE Estatus = 'Espera Interna' <span class="text-pink-400">LIMIT</span> 10</pre>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- Fin de sql-learning-section -->

        </div> <!-- Fin de querys-page-container -->
        
        <div id="loading-indicator" class="text-center py-10"><p class="text-gray-500 dark:text-gray-400">Cargando datos...</p></div>
    </div>

    <footer class="text-center py-8 border-t border-gray-200 dark:border-gray-700">
        <p class="text-sm text-gray-500 dark:text-gray-400">
            Herramienta creada por la Gerencia de Atenci√≥n al P√∫blico - Afore Coppel
        </p>
    </footer>

    <button id="add-item-btn" class="admin-only-flex fixed bottom-8 right-8 bg-blue-700 dark:bg-yellow-400 text-white dark:text-blue-900 w-16 h-16 rounded-full shadow-lg items-center justify-center text-3xl font-bold transform hover:scale-110 transition-transform">+</button>

    <!-- Modal Gen√©rico para Agregar/Editar Items -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-blue-800 dark:text-yellow-400">Agregar Nuevo</h2>
            <form id="script-form">
                <input type="hidden" id="item-id">
                <div class="space-y-4">
                    <input type="text" id="item-title" placeholder="T√≠tulo" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="item-description" placeholder="Descripci√≥n breve" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="2"></textarea>
                    <textarea id="item-text" placeholder="Texto completo del script/query..." required class="w-full p-2 border rounded font-mono dark:bg-gray-700 dark:border-gray-600" rows="6"></textarea>
                    
                    <!-- Categor√≠as para SCRIPTS -->
                    <select id="item-category-script" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- Seleccionar Categor√≠a --</option>
                        <option value="unificacion">Unificaci√≥n/Separaci√≥n</option>
                        <option value="exp">Exp. y Serv.</option>
                        <option value="parciales">Retiros Parciales</option>
                        <option value="totales">Retiros Totales</option>
                        <option value="extras">Extras</option>
                    </select>
                    
                    <!-- Categor√≠as para QUERYS -->
                    <select id="item-category-query" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- Seleccionar Servidor --</option>
                        <option value="aforeglobal">AforeGlobal</option>
                        <option value="safre">Safre</option>
                        <option value="notificaciones">Notificaciones</option>
                        <option value="admonafore">AdmonAfore</option>
                        <option value="serviciosafore">ServiciosAfore</option>
                        <option value="extra">Extra</option>
                    </select>

                    <input type="text" id="item-variables" placeholder="Variables (separadas por coma, ej: FECHA, MONTO)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-btn" class="py-2 px-4 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Guardar</button>
                </div>
            </form>
             <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>
    
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 class="text-xl font-bold mb-4">¬øEst√°s seguro?</h2>
            <p id="delete-modal-text" class="text-gray-600 dark:text-gray-300 mb-6">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="py-2 px-6 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">No</button>
                <button id="confirm-delete-btn" class="py-2 px-6 rounded bg-red-600 text-white hover:bg-red-700">S√≠, Eliminar</button>
            </div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 id="info-modal-title" class="text-xl font-bold mb-4 text-blue-800 dark:text-yellow-400">Solicitud Enviada</h2>
            <p id="info-modal-text" class="text-gray-600 dark:text-gray-300 mb-6">Tu solicitud ha sido enviada al Super Administrador para aprobaci√≥n.</p>
            <button id="info-modal-close" class="py-2 px-6 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Entendido</button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 relative">
            <h2 class="text-2xl font-bold mb-4 text-center text-blue-800 dark:text-yellow-400">Acceso Admin</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Correo electr√≥nico" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <input type="password" id="login-password" placeholder="Contrase√±a" required class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full py-2 px-4 rounded bg-blue-700 text-white hover:bg-blue-800 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">Iniciar Sesi√≥n</button>
                </div>
            </form>
            <button id="close-login-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
    </div>
    
    <script type="module">
        // --- IMPORTS DE FIREBASE (PRODUCCI√ìN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, increment, getDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        // --- CONFIGURACI√ìN DE PRODUCCI√ìN (TU C√ìDIGO ORIGINAL) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAvq0CF94lVwGZAtXiFZKHwS5q4ZA489lM",
          authDomain: "scripts-une-gap.firebaseapp.com",
          projectId: "scripts-une-gap",
          storageBucket: "scripts-une-gap.firebasestorage.app",
          messagingSenderId: "567975326387",
          appId: "1:567975326387:web:28edbab67668d1a829f6c6",
          measurementId: "G-GJK53TR2D6"
        };

        // --- INICIALIZACI√ìN DE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // setLogLevel('Debug'); // Descomentar para depurar en producci√≥n

        // --- DEFINICI√ìN DE COLECCIONES (PRODUCCI√ìN) ---
        const scriptsCollection = collection(db, 'scripts');
        const requestsCollection = collection(db, 'solicitudes');
        const querysCollection = collection(db, 'querys');
        const queryRequestsCollection = collection(db, 'solicitudes_querys');
        const userRolesCollection = collection(db, 'user_roles');

        // --- ESTADO GLOBAL DE LA APLICACI√ìN ---
        let currentView = 'scripts'; // 'scripts' o 'querys'
        let currentUserRole = null;
        let userId = null;
        let favorites = JSON.parse(localStorage.getItem('favoriteScripts')) || [];
        let queryFavorites = JSON.parse(localStorage.getItem('favoriteQuerys')) || []; // Favoritos para Querys
        const copiedScripts = new Set();
        const copiedQuerys = new Set(); // Copiados para Querys

        // --- ESTADO DE SCRIPTS ---
        let allScripts = [];
        let pendingRequests = [];
        let unsubscribeScripts = null;
        let unsubscribeRequests = null;

        // --- ESTADO DE QUERYS ---
        let allQuerys = [];
        let pendingQueryRequests = [];
        let unsubscribeQuerys = null;
        let unsubscribeQueryRequests = null;

        // --- ELEMENTOS DOM (SCRIPTS) ---
        const scriptsPage = document.getElementById('scripts-page-container');
        const scriptsContainer = document.getElementById('scripts-container');
        const scriptFilters = document.getElementById('category-filters');
        const scriptSearchInput = document.getElementById('search-input');
        
        // --- ELEMENTOS DOM (QUERYS) ---
        const querysPage = document.getElementById('querys-page-container');
        const querysContainer = document.getElementById('querys-container');
        const queryFilters = document.getElementById('query-category-filters');
        const querySearchInput = document.getElementById('query-search-input');
        const querySearchContainer = document.getElementById('query-search-container'); // Contenedor de la barra de b√∫squeda
        
        // --- ELEMENTOS DOM (NUEVA P√ÅGINA) ---
        const learningSection = document.getElementById('sql-learning-section');
        
        // --- ELEMENTOS DOM (GLOBALES) ---
        const mainNav = document.getElementById('main-nav');
        const loadingIndicator = document.getElementById('loading-indicator');
        const authControls = document.getElementById('auth-controls');

        // --- ============================================ ---
        // --- FUNCIONES DE RENDERIZADO (SCRIPTS)           ---
        // --- ============================================ ---

        const renderScripts = (scriptsToRender) => {
            if(!scriptsContainer) return;
            scriptsContainer.innerHTML = '';
            if (scriptsToRender.length === 0 && loadingIndicator.style.display === 'none') {
                scriptsContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No se encontraron resultados.</p>`;
                return;
            }

            const activeCategory = scriptFilters.querySelector('.active').dataset.category;
            const isPopularView = activeCategory === 'popular';
            
            scriptsToRender.forEach((script, index) => {
                const isFavorite = favorites.includes(script.id);
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 ease-in-out flex flex-col card-enter';
                card.style.animationDelay = `${index * 50}ms`;
                
                let variablesHtml = '';
                if (script.variables && script.variables.length > 0) {
                    const variableInputs = script.variables.map(v => `
                        <div class="flex items-center gap-2">
                            <label for="var-${script.id}-${v}" class="text-sm font-mono text-gray-600 dark:text-gray-300 w-1/3 truncate" title="${v}">${v}:</label>
                            <input type="text" id="var-${script.id}-${v}" data-variable-name="${v}" class="variable-input w-2/3 p-1 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm focus:ring-1 focus:ring-blue-500 dark:focus:ring-yellow-500 outline-none" placeholder="Valor para ${v}">
                        </div>
                    `).join('');
                    variablesHtml = `<div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-3"><h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">Reemplazar Variables:</h4><div class="space-y-2">${variableInputs}</div></div>`;
                }

                let popularBadgeHtml = '';
                if (isPopularView) {
                    const usageCount = script.copyCount || 0;
                    popularBadgeHtml = `<div class="absolute top-3 right-20 flex items-center gap-1 text-xs bg-red-100 text-red-800 dark:bg-orange-900 dark:text-orange-300 px-2 py-1 rounded-full font-semibold">üî•<span>${usageCount}</span></div>`;
                }
                
                let adminOptionsHtml = `
                        <div class="admin-only-flex absolute top-2 right-10 z-10">
                            <button class="options-btn p-1 text-gray-400 hover:text-blue-700 dark:hover:text-yellow-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>
                            </button>
                            <div class="options-menu absolute right-0 mt-8 w-40 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 hidden z-20">
                                <a href="#" class="edit-btn block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Modificar</a>
                                <a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/50">Eliminar</a>
                            </div>
                        </div>`;

                card.innerHTML = `
                             ${adminOptionsHtml}
                             ${popularBadgeHtml}
                             <div class="p-6 flex-grow">
                                 <div class="flex justify-between items-start">
                                     <h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2 pr-20">${script.title}</h2>
                                     <button class="favorite-btn absolute top-2 right-2 p-1 text-gray-400 hover:text-yellow-500 transition-colors">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="pointer-events-none transition-colors duration-200 ${isFavorite ? 'text-yellow-400' : 'text-gray-400/60 hover:text-yellow-400'}" viewBox="0 0 16 16">
                                             <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                         </svg>
                                     </button>
                                 </div>
                                 <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${script.description}</p>
                                 <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm text-gray-700 dark:text-gray-200 max-h-48 overflow-y-auto">
                                     <pre class="script-content font-sans">${script.scriptText}</pre>
                                 </div>
                                 ${variablesHtml}
                             </div>
                             <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                                 <button class="copy-btn w-full bg-yellow-400 text-blue-800 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ease-in-out hover:bg-yellow-500 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                                     <span>Copiar Script</span>
                                 </button>
                             </div>
                `;
                card.dataset.id = script.id;
                card.dataset.type = 'scripts';
                scriptsContainer.appendChild(card);

                // Revisa si el script reci√©n renderizado debe estar en estado "copiado"
                if (copiedScripts.has(script.id)) {
                    const copyBtn = card.querySelector('.copy-btn');
                    if (copyBtn) {
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>
                            <span>¬°Copiado!</span>`;
                        copyBtn.classList.add('copied');
                    }
                }
            });
        };

        const renderPendingRequests = (requests) => {
            if(!scriptsContainer) return;
            scriptsContainer.innerHTML = '';
            if (requests.length === 0) {
                scriptsContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No hay solicitudes pendientes.</p>`;
                return;
            }
            requests.forEach(request => {
                const req = request.data;
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden flex flex-col';
                
                let actionText = '';
                let actionColor = '';
                if (req.action === 'add') { actionText = 'NUEVO'; actionColor = 'bg-blue-500'; }
                if (req.action === 'edit') { actionText = 'MODIFICADO'; actionColor = 'bg-yellow-500'; }
                if (req.action === 'delete') { actionText = 'ELIMINAR'; actionColor = 'bg-red-500'; }

                card.innerHTML = `
                    <div class="absolute top-2 right-2 px-2 py-1 ${actionColor} text-white text-xs font-bold rounded-full">${actionText}</div>
                    <div class="p-6">
                        <h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2">${req.title}</h2>
                        <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${req.description}</p>
                        <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm text-gray-700 dark:text-gray-200 max-h-48 overflow-y-auto">
                            <pre class="script-content font-sans">${req.scriptText}</pre>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 mt-auto flex gap-2">
                        <button data-id="${request.id}" class="reject-btn w-1/2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors hover:bg-red-700">Rechazar</button>
                        <button data-id="${request.id}" class="approve-btn w-1/2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors hover:bg-green-700">Aprobar</button>
                    </div>
                `;
                scriptsContainer.appendChild(card);
            });
        };

        // --- ============================================ ---
        // --- FUNCIONES DE RENDERIZADO (QUERYS)            ---
        // --- ============================================ ---

        const renderQuerys = (querysToRender) => {
            if(!querysContainer) return;
            querysContainer.innerHTML = '';
            if (querysToRender.length === 0 && loadingIndicator.style.display === 'none') {
                querysContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No se encontraron resultados.</p>`;
                return;
            }

            const activeCategory = queryFilters.querySelector('.active').dataset.category;
            const isPopularView = activeCategory === 'popular';
            
            querysToRender.forEach((query, index) => {
                const isFavorite = queryFavorites.includes(query.id);
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 ease-in-out flex flex-col card-enter';
                card.style.animationDelay = `${index * 50}ms`;

                // =========================================================
                // INICIO DEL C√ìDIGO A√ëADIDO
                // =========================================================
                // 1. Mapeo para mostrar nombres "bonitos"
                const serverNames = {
                    'aforeglobal': 'AforeGlobal',
                    'safre': 'Safre',
                    'notificaciones': 'Notificaciones',
                    'admonafore': 'AdmonAfore',
                    'serviciosafore': 'ServiciosAfore',
                    'extra': 'Extra'
                };
                
                // 2. Obtener el nombre del servidor y crear el HTML
                let serverBadgeHtml = '';
                const serverName = serverNames[query.category]; // Usar el mapeo
                
                if (serverName) {
                    // Usamos el mismo estilo del bloque de "variables" de los scripts
                    serverBadgeHtml = `
                        <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-3">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">Servidor de Ejecuci√≥n:</h4>
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-blue-500 dark:text-yellow-400 shrink-0" viewBox="0 0 16 16">
                                    <path d="M4 1.026a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V1.026zM5 1.526v3.448h6V1.526H5z"/>
                                    <path d="M12.5 6a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V6.5a.5.5 0 0 1 .5-.5h7zM5 6.526v3.448h6V6.526H5z"/>
                                    <path d="M4 11.026a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v3.974a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V11.026zM5 11.526v3.448h6v-3.448H5z"/>
                                </svg>
                                <span class="font-mono font-bold text-gray-800 dark:text-gray-200 text-sm">${serverName}</span>
                            </div>
                        </div>`;
                }
                // =========================================================
                // FIN DEL C√ìDIGO A√ëADIDO
                // =========================================================
                
                let popularBadgeHtml = '';
                if (isPopularView) {
                    const usageCount = query.copyCount || 0;
                    popularBadgeHtml = `<div class="absolute top-3 right-20 flex items-center gap-1 text-xs bg-red-100 text-red-800 dark:bg-orange-900 dark:text-orange-300 px-2 py-1 rounded-full font-semibold">üî•<span>${usageCount}</span></div>`;
                }
                
                let adminOptionsHtml = `
                        <div class="admin-only-flex absolute top-2 right-10 z-10">
                            <button class="options-btn p-1 text-gray-400 hover:text-blue-700 dark:hover:text-yellow-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>
                            </button>
                            <div class="options-menu absolute right-0 mt-8 w-40 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 hidden z-20">
                                <a href="#" class="edit-btn block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Modificar</a>
                                <a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/50">Eliminar</a>
                            </div>
                        </div>`;

                card.innerHTML = `
                             ${adminOptionsHtml}
                             ${popularBadgeHtml}
                             <div class="p-6 flex-grow">
                                 <div class="flex justify-between items-start">
                                     <h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2 pr-20">${query.title}</h2>
                                     <button class="favorite-btn absolute top-2 right-2 p-1 text-gray-400 hover:text-yellow-500 transition-colors">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="pointer-events-none transition-colors duration-200 ${isFavorite ? 'text-yellow-400' : 'text-gray-400/60 hover:text-yellow-400'}" viewBox="0 0 16 16">
                                             <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                         </svg>
                                     </button>
                                 </div>
                                 <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${query.description}</p>
                                 <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm text-gray-700 dark:text-gray-200 max-h-32 overflow-y-auto">
                                     <pre class="script-content font-mono">${query.scriptText}</pre>
                                 </div>
                                 
                                 ${serverBadgeHtml}
                                 
                             </div>
                             <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                                 <button class="copy-btn w-full bg-yellow-400 text-blue-800 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ease-in-out hover:bg-yellow-500 dark:bg-yellow-400 dark:text-blue-900 dark:hover:bg-yellow-500">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                                     <span>Copiar Query</span>
                                 </button>
                             </div>
                `;
                card.dataset.id = query.id;
                card.dataset.type = 'query';
                querysContainer.appendChild(card);

                if (copiedQuerys.has(query.id)) {
                    const copyBtn = card.querySelector('.copy-btn');
                    if (copyBtn) {
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>
                            <span>¬°Copiado!</span>`;
                        copyBtn.classList.add('copied');
                    }
                }
            });
        };

        const renderPendingQueryRequests = (requests) => {
            if(!querysContainer) return;
            querysContainer.innerHTML = '';
            if (requests.length === 0) {
                querysContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center mt-4">No hay solicitudes pendientes.</p>`;
                return;
            }
            requests.forEach(request => {
                const req = request.data;
                const card = document.createElement('div');
                card.className = 'relative bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden flex flex-col';
                
                let actionText = '';
                let actionColor = '';
                if (req.action === 'add') { actionText = 'NUEVO'; actionColor = 'bg-blue-500'; }
                if (req.action === 'edit') { actionText = 'MODIFICADO'; actionColor = 'bg-yellow-500'; }
                if (req.action === 'delete') { actionText = 'ELIMINAR'; actionColor = 'bg-red-500'; }

                card.innerHTML = `
                    <div class="absolute top-2 right-2 px-2 py-1 ${actionColor} text-white text-xs font-bold rounded-full">${actionText}</div>
                    <div class="p-6">
                        <h2 class="text-xl font-bold text-blue-800 dark:text-yellow-400 mb-2">${req.title}</h2>
                        <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${req.description}</p>
                        <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 text-sm text-gray-700 dark:text-gray-200 max-h-48 overflow-y-auto">
                            <pre class="script-content font-sans">${req.scriptText}</pre>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 mt-auto flex gap-2">
                        <button data-id="${request.id}" class="reject-btn w-1/2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors hover:bg-red-700">Rechazar</button>
                        <button data-id="${request.id}" class="approve-btn w-1/2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors hover:bg-green-700">Aprobar</button>
                    </div>
                `;
                querysContainer.appendChild(card);
            });
        };
        
        // --- ============================================ ---
        // --- L√ìGICA DE FILTROS Y NAVEGACI√ìN               ---
        // --- ============================================ ---
        
        const applyScriptFilters = () => {
            if (!scriptSearchInput || !scriptFilters) { console.warn("Elementos de filtro de script no encontrados."); return; }
            const searchTerm = scriptSearchInput.value.toLowerCase();
            const activeCategory = scriptFilters.querySelector('.active').dataset.category;

            let filteredScripts = [];
            
            if (activeCategory === 'requests') {
                filteredScripts = pendingRequests;
                renderPendingRequests(filteredScripts);
                return;
            } else if (activeCategory === 'favorites') {
                filteredScripts = allScripts.filter(script => favorites.includes(script.id));
            } else if (activeCategory === 'popular') {
                filteredScripts = [...allScripts].sort((a, b) => (b.copyCount || 0) - (a.copyCount || 0));
            } else if (activeCategory !== 'all') {
                filteredScripts = allScripts.filter(script => script.category === activeCategory);
            } else {
                filteredScripts = allScripts;
            }
            
            if (searchTerm) {
                filteredScripts = filteredScripts.filter(s => s.title.toLowerCase().includes(searchTerm) || s.description.toLowerCase().includes(searchTerm));
            }
            renderScripts(filteredScripts);
        };

        const applyQueryFilters = () => {
            if (!querySearchInput || !queryFilters) { console.warn("Elementos de filtro de query no encontrados."); return; }
            const searchTerm = querySearchInput.value.toLowerCase();
            const activeCategory = queryFilters.querySelector('.active').dataset.category;

            let filteredQuerys = [];

            if (activeCategory === 'requests') {
                filteredQuerys = pendingQueryRequests;
                renderPendingQueryRequests(filteredQuerys);
                return;
            } else if (activeCategory === 'favorites') {
                filteredQuerys = allQuerys.filter(query => queryFavorites.includes(query.id));
            } else if (activeCategory === 'popular') {
                filteredQuerys = [...allQuerys].sort((a, b) => (b.copyCount || 0) - (a.copyCount || 0));
            } else if (activeCategory !== 'all') {
                filteredQuerys = allQuerys.filter(query => query.category === activeCategory);
            } else {
                filteredQuerys = allQuerys;
            }
            
            if (searchTerm) {
                filteredQuerys = filteredQuerys.filter(q => q.title.toLowerCase().includes(searchTerm) || q.description.toLowerCase().includes(searchTerm));
            }
            renderQuerys(filteredQuerys);
        };

        const navigateTo = (view) => {
            // =========================================================
            // INICIO DE LA SOLUCI√ìN:
            // Cierra el modal para limpiar el estado 'required' antes de cambiar de vista.
            if (itemModal) closeModal();
            // FIN DE LA SOLUCI√ìN
            // =========================================================

            currentView = view;
            if (view === 'scripts') {
                scriptsPage.classList.remove('hidden');
                querysPage.classList.add('hidden');
                mainNav.querySelector('[data-view="scripts"]').classList.add('active');
                mainNav.querySelector('[data-view="querys"]').classList.remove('active');
                applyScriptFilters();
            } else if (view === 'querys') {
                scriptsPage.classList.add('hidden');
                querysPage.classList.remove('hidden');
                mainNav.querySelector('[data-view="scripts"]').classList.remove('active');
                mainNav.querySelector('[data-view="querys"]').classList.add('active');
                
                const activeQueryFilter = queryFilters.querySelector('.active').dataset.category;
                if (activeQueryFilter === 'learn') {
                    if(querysContainer) querysContainer.classList.add('hidden');
                    if(learningSection) learningSection.classList.remove('hidden');
                    if(querySearchContainer) querySearchContainer.classList.add('hidden');
                } else {
                    applyQueryFilters();
                }
            }
        };

        if(mainNav) mainNav.addEventListener('click', (e) => {
            const button = e.target.closest('.main-nav-btn');
            if (button) {
                const view = button.dataset.view;
                navigateTo(view);
            }
        });

        // --- ============================================ ---
        // --- L√ìGICA DE FIREBASE Y AUTENTICACI√ìN           ---
        // --- ============================================ ---

        const setupAdminUI = (role) => {
            if (role) {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');
            }
            document.querySelectorAll('[data-category="requests"]').forEach(btn => {
                if (role === 'superadmin') {
                    btn.style.display = 'flex';
                } else {
                    btn.style.display = 'none';
                }
            });
        };

        const setupFirestoreListeners = () => {
            // Limpiar listeners anteriores
            if (unsubscribeScripts) unsubscribeScripts();
            if (unsubscribeRequests) unsubscribeRequests();
            if (unsubscribeQuerys) unsubscribeQuerys();
            if (unsubscribeQueryRequests) unsubscribeQueryRequests();

            // Listener de SCRIPTS
            unsubscribeScripts = onSnapshot(scriptsCollection, (snapshot) => {
                allScripts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'scripts') applyScriptFilters();
                if(currentView === 'scripts' || allQuerys.length > 0 || (currentView === 'querys' && queryFilters.querySelector('.active').dataset.category === 'learn')) loadingIndicator.style.display = 'none';
            }, (error) => {
                console.error("Error al obtener scripts: ", error);
                loadingIndicator.innerHTML = '<p class="text-red-500">Error al cargar scripts.</p>';
            });

            // Listener de QUERYS
            unsubscribeQuerys = onSnapshot(querysCollection, (snapshot) => {
                allQuerys = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'querys') applyQueryFilters();
                if(currentView === 'querys' || allScripts.length > 0) loadingIndicator.style.display = 'none';
            }, (error) => {
                console.error("Error al obtener querys: ", error);
                loadingIndicator.innerHTML = '<p class="text-red-500">Error al cargar querys.</p>';
            });

            // Si es superadmin, escuchar ambas colecciones de solicitudes
            if (currentUserRole === 'superadmin') {
                unsubscribeRequests = onSnapshot(requestsCollection, (snapshot) => {
                    pendingRequests = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    const badge = document.getElementById('requests-count-badge');
                    if (badge) {
                        badge.textContent = pendingRequests.length;
                        badge.classList.toggle('hidden', pendingRequests.length === 0);
                    }
                    if (currentView === 'scripts' && scriptFilters.querySelector('.active').dataset.category === 'requests') {
                        renderPendingRequests(pendingRequests);
                    }
                });

                unsubscribeQueryRequests = onSnapshot(queryRequestsCollection, (snapshot) => {
                    pendingQueryRequests = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    const badge = document.getElementById('query-requests-count-badge');
                    if (badge) {
                        badge.textContent = pendingQueryRequests.length;
                        badge.classList.toggle('hidden', pendingQueryRequests.length === 0);
                    }
                    if (currentView === 'querys' && queryFilters.querySelector('.active').dataset.category === 'requests') {
                        renderPendingQueryRequests(pendingQueryRequests);
                    }
                });
            }
        };

        onAuthStateChanged(auth, async (user) => {
            // Limpiar listeners anteriores para evitar duplicados
            if (unsubscribeScripts) unsubscribeScripts();
            if (unsubscribeRequests) unsubscribeRequests();
            if (unsubscribeQuerys) unsubscribeQuerys();
            if (unsubscribeQueryRequests) unsubscribeQueryRequests();
            
            currentUserRole = null;
            userId = user ? user.uid : null;
            
            if (user) {
                // --- USUARIO EST√Å AUTENTICADO (TOKEN, EMAIL, O AN√ìNIMO) ---
                userId = user.uid;
                try {
                    // Intentar obtener el rol del usuario
                    const roleDocRef = doc(userRolesCollection, user.uid);
                    const roleDocSnap = await getDoc(roleDocRef);
                    
                    if (roleDocSnap.exists()) {
                        currentUserRole = roleDocSnap.data().role;
                        console.log("Rol de usuario:", currentUserRole);
                    } else {
                        console.log("Usuario logueado pero sin rol asignado (an√≥nimo).");
                    }
                } catch (e) {
                    console.error("Error al obtener el rol del usuario: ", e);
                }
    
                // Configurar la UI basada en si es an√≥nimo o un admin logueado
                if (user.isAnonymous) {
                     authControls.innerHTML = `<button id="login-btn" title="Acceso Admin" class="p-1 rounded-full text-blue-600 dark:text-yellow-400 hover:text-blue-800 dark:hover:text-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16"><path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.056.255.098.386.123.134.026.275.042.415.042.14 0 .281-.016.415-.042.131-.025.266-.067.386-.123.241-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.018 7.018 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.016 7.016 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/><path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.965a.5.5 0 1 1-.966.19l-.385-1.965a1.5 1.5 0 1 1 1.966-1.606z"/></svg></button>`;
                     if(document.getElementById('login-btn')) document.getElementById('login-btn').addEventListener('click', openLoginModal);
                     setupAdminUI(null);
                } else {
                    // Usuario real logueado
                    authControls.innerHTML = `<button id="logout-btn" class="text-sm text-gray-500 hover:text-blue-700 dark:hover:text-yellow-400">Salir</button>`;
                    if(document.getElementById('logout-btn')) document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                    setupAdminUI(currentUserRole);
                }
    
                // ¬°Importante! Cargar datos para TODOS (an√≥nimos y admins)
                setupFirestoreListeners();
                navigateTo(currentView); 
    
            } else {
                // --- USUARIO ES NULL (Pasa en la carga inicial) ---
                console.log("Usuario es null. Intentando inicio an√≥nimo...");
                
                // Configurar UI para visitante
                setupAdminUI(null);
                authControls.innerHTML = `<button id="login-btn" title="Acceso Admin" class="p-1 rounded-full text-blue-600 dark:text-yellow-400 hover:text-blue-800 dark:hover:text-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16"><path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.056.255.098.386.123.134.026.275.042.415.042.14 0 .281-.016.415-.042.131-.025.266-.067.386-.123.241-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.018 7.018 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.016 7.016 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/><path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.965a.5.5 0 1 1-.966.19l-.385-1.965a1.5 1.5 0 1 1 1.966-1.606z"/></svg></button>`;
                if(document.getElementById('login-btn')) {
                    document.getElementById('login-btn').addEventListener('click', openLoginModal);
                }
    
                // Intentar iniciar sesi√≥n an√≥nimamente
                try {
                    await signInAnonymously(auth);
                    // onAuthStateChanged se volver√° a disparar, esta vez con un usuario an√≥nimo.
                } catch (error) {
                     console.error("Error en el inicio de sesi√≥n an√≥nimo:", error);
                     loadingIndicator.innerHTML = '<p class="text-red-500">Error de autenticaci√≥n. No se pueden cargar los datos.</p>';
                }
            }
        });
    
        // --- ============================================ ---
        // --- L√ìGICA DE EVENTOS DE UI (GENERAL)            ---
        // --- ============================================ ---

        document.getElementById('app-container').addEventListener('click', async function(e) {
            const card = e.target.closest('[data-id]');
            // Salir si se hizo clic en el m√≥dulo de aprendizaje o si no se hizo clic en una tarjeta
            if (e.target.closest('#sql-learning-section') || !card) return;

            const cardId = card.dataset.id;
            const cardType = card.dataset.type; // 'script' o 'query'
            
            const copyButton = e.target.closest('.copy-btn');
            const favButton = e.target.closest('.favorite-btn');
            const optionsButton = e.target.closest('.options-btn');
            const editButton = e.target.closest('.edit-btn');
            const deleteButton = e.target.closest('.delete-btn');
            const approveButton = e.target.closest('.approve-btn');
            const rejectButton = e.target.closest('.reject-btn');

            // --- L√≥gica de Copiar ---
            if (copyButton && (cardType === 'script' || cardType === 'query')) {
                const currentSet = cardType === 'script' ? copiedScripts : copiedQuerys;
                const renderFunc = cardType === 'script' ? applyScriptFilters : applyQueryFilters;
                const collection = cardType === 'script' ? scriptsCollection : querysCollection;
                
                if (currentSet.has(cardId)) return;

                let scriptTextToCopy = card.querySelector('.script-content').textContent;
                
                if (cardType === 'script') {
                    const variableInputs = card.querySelectorAll('.variable-input');
                    if (variableInputs.length > 0) {
                        variableInputs.forEach(input => {
                            const varName = input.dataset.variableName;
                            const varValue = input.value || `[${varName}]`;
                            const regex = new RegExp(varName, 'g');
                            scriptTextToCopy = scriptTextToCopy.replace(regex, varValue);
                        });
                    }
                }
                
                const textArea = document.createElement("textarea");
                textArea.value = scriptTextToCopy;
                textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);

                const itemRef = doc(collection, cardId);
                try {
                    await updateDoc(itemRef, { copyCount: increment(1) });
                } catch (error) {
                    console.warn("No se pudo actualizar el contador de copias", error.message);
                }

                currentSet.add(cardId);
                renderFunc();
                setTimeout(() => {
                    currentSet.delete(cardId);
                    renderFunc();
                }, 2000);
            }

            // --- L√≥gica de Favoritos (CORRECCI√ìN DEFINITIVA) ---
            if (favButton && cardType === 'script') {
                const storageKey = 'favoriteScripts';
                const index = favorites.indexOf(cardId);
                
                if (index > -1) {
                    // Si ya existe, quitarlo del array global
                    favorites.splice(index, 1);
                } else {
                    // Si no existe, agregarlo
                    favorites.push(cardId);
                }
                
                // Guardar en localStorage y re-dibujar la vista
                localStorage.setItem(storageKey, JSON.stringify(favorites));
                applyScriptFilters(); 
            }

            if (favButton && cardType === 'query') {
                const storageKey = 'favoriteQuerys';
                const index = queryFavorites.indexOf(cardId);

                if (index > -1) {
                    // Si ya existe, quitarlo
                    queryFavorites.splice(index, 1);
                } else {
                    // Si no existe, agregarlo
                    queryFavorites.push(cardId);
                }

                // Guardar en localStorage y re-dibujar la vista
                localStorage.setItem(storageKey, JSON.stringify(queryFavorites));
                applyQueryFilters();
            }
            
            // --- L√≥gica de Opciones Admin ---
            if (optionsButton) {
                document.querySelectorAll('.options-menu').forEach(m => {
                    if (m !== optionsButton.nextElementSibling) m.classList.add('hidden');
                });
                optionsButton.nextElementSibling.classList.toggle('hidden');
            }
            if (editButton) {
                openEditModal(cardId, cardType);
            }
            if (deleteButton) {
                openDeleteModal(cardId, cardType);
            }
            
            // --- L√≥gica de Aprobaci√≥n (Super Admin) ---
            if (approveButton) {
                handleApproval(cardId, cardType, true);
            }
            if (rejectButton) {
                handleApproval(cardId, cardType, false);
            }
        });

        // --- Clicks en Filtros ---
        function handleFilterClicks(e) {
            const button = e.target.closest('.nav-button');
            if (!button) return;
            const nav = button.closest('nav');
            if (!nav) return;

            const newCategory = button.dataset.category;

            const activeButton = nav.querySelector('.active');
            if (activeButton) activeButton.classList.remove('active');
            button.classList.add('active');

            if (nav.id === 'category-filters') {
                applyScriptFilters();
            } else if (nav.id === 'query-category-filters') {
                if (newCategory === 'learn') {
                    if(querysContainer) querysContainer.classList.add('hidden');
                    if(learningSection) learningSection.classList.remove('hidden');
                    if(querySearchContainer) querySearchContainer.classList.add('hidden');
                } else {
                    if(querysContainer) querysContainer.classList.remove('hidden');
                    if(learningSection) learningSection.classList.add('hidden');
                    if(querySearchContainer) querySearchContainer.classList.remove('hidden');
                    applyQueryFilters();
                }
            }
        }
        if (scriptFilters) scriptFilters.addEventListener('click', handleFilterClicks);
        if (queryFilters) queryFilters.addEventListener('click', handleFilterClicks);


        // --- B√∫squeda ---
        if (scriptSearchInput) {
            scriptSearchInput.addEventListener('input', applyScriptFilters);
        } else {
            console.error("No se pudo encontrar el elemento 'search-input'.");
        }
        if (querySearchInput) {
            querySearchInput.addEventListener('input', applyQueryFilters);
        } else {
            console.error("No se pudo encontrar el elemento 'query-search-input'.");
        }


        // --- Ocultar men√∫s de opciones ---
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.options-btn')) {
                document.querySelectorAll('.options-menu').forEach(m => m.classList.add('hidden'));
            }
        });
        
        // --- ============================================ ---
        // --- L√ìGICA DE MODALES (GEN√âRICA)                 ---
        // --- ============================================ ---

        // --- Modales Globales ---
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const closeLoginModalBtn = document.getElementById('close-login-modal-btn');
        const loginError = document.getElementById('login-error');
        
        const openLoginModal = () => { loginModal.classList.remove('hidden'); setTimeout(() => loginModal.classList.remove('opacity-0'), 10); };
        const closeLoginModal = () => { loginModal.classList.add('opacity-0'); setTimeout(() => { loginModal.classList.add('hidden'); loginForm.reset(); loginError.classList.add('hidden'); }, 300); };
        
        if(closeLoginModalBtn) closeLoginModalBtn.addEventListener('click', closeLoginModal);
        if(loginModal) loginModal.addEventListener('click', (e) => { if (e.target === loginModal) closeLoginModal(); });
        
        if(loginForm) loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeLoginModal();
            } catch (error) {
                loginError.textContent = 'Credenciales incorrectas.';
                loginError.classList.remove('hidden');
            }
        });
        
        // --- Modal de Agregar/Editar Item ---
        const itemModal = document.getElementById('add-item-modal');
        const addItemBtn = document.getElementById('add-item-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const itemForm = document.getElementById('script-form');
        const modalTitle = document.getElementById('modal-title');
        const itemIdInput = document.getElementById('item-id');

        const scriptCategorySelect = document.getElementById('item-category-script');
        const queryCategorySelect = document.getElementById('item-category-query');
        const variablesInput = document.getElementById('item-variables');
        
        // ****** INICIO DE LA CORRECCI√ìN ******
        // Esta es la √öNICA versi√≥n de openModal que debe existir
        const openModal = (title = "Agregar Nuevo") => {
            modalTitle.textContent = title;
            
            // --- INICIO DE LA CORRECCI√ìN (RESTAURACI√ìN) ---
            // Restauramos la validaci√≥n est√°ndar para los campos de texto
            // cada vez que el modal se abre para Agregar o Modificar.
            document.getElementById('item-title').required = true;
            document.getElementById('item-description').required = true;
            document.getElementById('item-text').required = true;
            // --- FIN DE LA CORRECCI√ìN (RESTAURACI√ìN) ---

            if (currentView === 'scripts') {
                scriptCategorySelect.classList.remove('hidden');
                scriptCategorySelect.required = true; // S√ç es requerido
                queryCategorySelect.classList.add('hidden');
                queryCategorySelect.required = false; // NO es requerido
                variablesInput.classList.remove('hidden');
            } else { // 'querys'
                scriptCategorySelect.classList.add('hidden');
                scriptCategorySelect.required = false; // NO es requerido
                queryCategorySelect.classList.remove('hidden');
                queryCategorySelect.required = true; // S√ç es requerido
                variablesInput.classList.add('hidden');
            }
            
            itemModal.classList.remove('hidden');
            setTimeout(() => itemModal.classList.remove('opacity-0'), 10);
        };
        // ****** FIN DE LA CORRECCI√ìN ******
        
        // ****** INICIO DE LA CORRECCI√ìN ******
    // Esta es la √öNICA versi√≥n de closeModal que debe existir
    const closeModal = () => {
        itemModal.classList.add('opacity-0');
        setTimeout(() => {
            itemModal.classList.add('hidden');
            itemForm.reset();
            itemIdInput.value = '';

            // --- INICIO DEL FIX DEFINITIVO ---
            // Neutralizamos la validaci√≥n del formulario oculto
            // para que el navegador no bloquee otros clics.
            document.getElementById('item-title').required = false;
            document.getElementById('item-description').required = false;
            document.getElementById('item-text').required = false;
            scriptCategorySelect.required = false;
            queryCategorySelect.required = false;
            // --- FIN DEL FIX DEFINITIVO ---

        }, 300);
    };
    // ****** FIN DE LA CORRECCI√ìN ******
        
        if(addItemBtn) addItemBtn.addEventListener('click', () => openModal(currentView === 'scripts' ? 'Agregar Nuevo Script' : 'Agregar Nueva Query'));
        if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
        if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if(itemModal) itemModal.addEventListener('click', (e) => { if (e.target === itemModal) closeModal(); });

        const openEditModal = (id, type) => {
            const collection = type === 'scripts' ? allScripts : allQuerys;
            const itemToEdit = collection.find(item => item.id === id);
            if (!itemToEdit) return;
            
            itemIdInput.value = id;
            document.getElementById('item-title').value = itemToEdit.title;
            document.getElementById('item-description').value = itemToEdit.description;
            document.getElementById('item-text').value = itemToEdit.scriptText;
            
            if (type === 'scripts') {
                document.getElementById('item-category-script').value = itemToEdit.category;
                document.getElementById('item-variables').value = (itemToEdit.variables || []).join(', ');
            } else { // 'querys'
                document.getElementById('item-category-query').value = itemToEdit.category;
            }
            
            openModal(type === 'scripts' ? 'Modificar Script' : 'Modificar Query');
        };

        if(itemForm) itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = itemIdInput.value;
            const isEdit = !!itemId;
            
            const itemData = {
                title: document.getElementById('item-title').value,
                description: document.getElementById('item-description').value,
                scriptText: document.getElementById('item-text').value,
                category: currentView === 'scripts' ? scriptCategorySelect.value : queryCategorySelect.value,
                variables: currentView === 'scripts' ? document.getElementById('item-variables').value.split(',').map(v => v.trim()).filter(v => v) : [],
                lastUpdatedBy: userId,
                updatedAt: serverTimestamp()
            };
            
            const action = isEdit ? 'edit' : 'add';
            const collection = currentView === 'scripts' ? scriptsCollection : querysCollection;
            const requests = currentView === 'scripts' ? requestsCollection : queryRequestsCollection;

            try {
                if (currentUserRole === 'superadmin') {
                    if (isEdit) {
                        const itemRef = doc(collection, itemId);
                        await updateDoc(itemRef, itemData);
                    } else {
                        itemData.copyCount = 0;
                        await addDoc(collection, itemData);
                    }
                } else if (currentUserRole === 'admin') {
                    const requestData = {
                        ...itemData,
                        action: action,
                        originalId: itemId || null,
                        status: 'pending',
                        requestedBy: userId,
                        timestamp: serverTimestamp()
                    };
                    await addDoc(requests, requestData);
                    openInfoModal('Solicitud Enviada', 'Tu solicitud ha sido enviada al Super Administrador para aprobaci√≥n.');
                }
                closeModal();
            } catch (error) { console.error("Error al guardar: ", error); alert("Hubo un error al guardar."); }
        });

        // --- Modal de Confirmaci√≥n (Info) ---
        const infoModal = document.getElementById('info-modal');
        const infoModalTitle = document.getElementById('info-modal-title');
        const infoModalText = document.getElementById('info-modal-text');
        const infoModalClose = document.getElementById('info-modal-close');

        const openInfoModal = (title, text) => {
            infoModalTitle.textContent = title;
            infoModalText.textContent = text;
            infoModal.classList.remove('hidden');
            setTimeout(() => infoModal.classList.remove('opacity-0'), 10);
        };
        const closeInfoModal = () => {
            infoModal.classList.add('opacity-0');
            setTimeout(() => infoModal.classList.add('hidden'), 300);
        };
        if(infoModalClose) infoModalClose.addEventListener('click', closeInfoModal);
        if(infoModal) infoModal.addEventListener('click', (e) => { if (e.target === infoModal) closeInfoModal(); });


        // --- Modal de Eliminar (Delete) ---
        const deleteModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const deleteModalText = document.getElementById('delete-modal-text');
        let itemToDelete = { id: null, type: null };
       
        // ****** INICIO DE LA CORRECCI√ìN ******
        // Esta es la √öNICA versi√≥n de openDeleteModal que debe existir
        const openDeleteModal = (id, type) => {
            itemToDelete = { id: id, type: type };
            const collection = type === 'scripts' ? allScripts : allQuerys;
            const item = collection.find(i => i.id === id);
            
            if (!item) {
                console.error("Item no encontrado para eliminar");
                return;
            }

            // --- INICIO DE LA CORRECCI√ìN MEJORADA ---
            // Desactivamos temporalmente TODA la validaci√≥n del formulario de "Agregar/Editar"
            // (que est√° oculto) para prevenir que el navegador bloquee el clic del bot√≥n "S√≠, Eliminar".
            document.getElementById('item-title').required = false;
            document.getElementById('item-description').required = false;
            document.getElementById('item-text').required = false;
            scriptCategorySelect.required = false;
            queryCategorySelect.required = false;
            // --- FIN DE LA CORRECCI√ìN MEJORADA ---
            
            if (currentUserRole === 'superadmin') {
                deleteModalText.textContent = `¬øSeguro que quieres eliminar "${item.title}"? Esta acci√≥n no se puede deshacer.`;
            } else {
                deleteModalText.textContent = `¬øEnviar solicitud para eliminar "${item.title}"?`;
            }
            
            deleteModal.classList.remove('hidden');
            setTimeout(() => deleteModal.classList.remove('opacity-0'), 10);
        };
        // ****** FIN DE LA CORRECCI√ìN ******

         const closeDeleteModal = () => {
            deleteModal.classList.add('opacity-0');
            setTimeout(() => { deleteModal.classList.add('hidden'); itemToDelete = { id: null, type: null }; }, 300);
        };
        
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        if(deleteModal) deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeDeleteModal(); });
        
        if(confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', async () => {
            if (!itemToDelete.id || !itemToDelete.type) return;

            const { id, type } = itemToDelete;
            const collection = type === 'scripts' ? scriptsCollection : querysCollection;
            const requests = type === 'scripts' ? requestsCollection : queryRequestsCollection;
            const allItems = type === 'scripts' ? allScripts : allQuerys;
            const item = allItems.find(i => i.id === id);
            
            if (!item) {
                console.error("Item no encontrado para procesar eliminaci√≥n");
                closeDeleteModal();
                return;
            }

            try {
                if (currentUserRole === 'superadmin') {
                    await deleteDoc(doc(collection, id));
                } else if (currentUserRole === 'admin') {
                    const requestData = {
                        action: 'delete',
                        originalId: id,
                        title: item.title,
                        description: item.description,
                        scriptText: item.scriptText,
                        category: item.category,
                        variables: item.variables || [],
                        status: 'pending',
                        requestedBy: userId,
                        timestamp: serverTimestamp()
                    };
                    await addDoc(requests, requestData);
                    openInfoModal('Solicitud Enviada', `Tu solicitud para eliminar "${item.title}" ha sido enviada.`);
                }
                closeDeleteModal();
            } catch (error) { console.error("Error al eliminar: ", error); alert("Hubo un error al procesar la solicitud."); }
        });
        
        // --- L√≥gica de Aprobaci√≥n (Super Admin) ---
        const handleApproval = async (requestId, type, isApproved) => {
            const requests = type === 'scripts' ? requestsCollection : queryRequestsCollection;
            const collection = type === 'scripts' ? scriptsCollection : querysCollection;
            const requestDocRef = doc(requests, requestId);
            
            try {
                const requestSnap = await getDoc(requestDocRef);
                if (!requestSnap.exists()) return;
                
                const reqData = requestSnap.data();
                
                if (isApproved) {
                    const itemData = {
                        title: reqData.title,
                        description: reqData.description,
                        scriptText: reqData.scriptText,
                        category: reqData.category,
                        variables: reqData.variables || [],
                        lastUpdatedBy: reqData.requestedBy,
                        updatedAt: serverTimestamp()
                    };

                    if (reqData.action === 'add') {
                        itemData.copyCount = 0;
                        await addDoc(collection, itemData);
                    } else if (reqData.action === 'edit') {
                        await updateDoc(doc(collection, reqData.originalId), itemData);
                    } else if (reqData.action === 'delete') {
                        await deleteDoc(doc(collection, reqData.originalId));
                    }
                }
                await deleteDoc(requestDocRef);
                
            } catch (error) {
                console.error("Error al procesar la aprobaci√≥n: ", error);
                alert("Error al procesar la solicitud.");
            }
        };
        
        
        // --- ============================================ ---
        // --- L√ìGICA DEL ACORDE√ìN Y SQL INTERACTIVO         ---
        // --- ============================================ ---

        if (learningSection) {
            
            const interactiveSqlBlock = document.getElementById('interactive-sql-block');
            const explanationBox = document.getElementById('sql-explanation-box');
            if (interactiveSqlBlock && explanationBox) {
                const explanations = explanationBox.querySelectorAll('.sql-explanation');
                const hoverTargets = interactiveSqlBlock.querySelectorAll('[data-hover-target]');
                const defaultExplanation = document.getElementById('exp-default');

                hoverTargets.forEach(target => {
                    target.addEventListener('mouseover', () => {
                        const targetId = target.getAttribute('data-hover-target');
                        
                        explanations.forEach(exp => exp.classList.add('hidden'));
                        hoverTargets.forEach(t => {
                             t.classList.remove('bg-yellow-200', 'dark:bg-yellow-700', 'text-black', 'dark:text-black');
                             if (t.getAttribute('data-hover-target') === 'exp-select' || t.getAttribute('data-hover-target') === 'exp-from' || t.getAttribute('data-hover-target') === 'exp-where') t.classList.add('text-pink-400');
                             if (t.getAttribute('data-hover-target') === 'exp-table') t.classList.add('text-green-400');
                             if (t.getAttribute('data-hover-target') === 'exp-condition') t.classList.add('text-blue-300');
                             if (t.getAttribute('data-hover-target') === 'exp-all') t.classList.add('text-gray-300');
                        });
                        
                        const activeExplanation = document.getElementById(targetId);
                        if (activeExplanation) {
                            activeExplanation.classList.remove('hidden');
                            target.classList.add('bg-yellow-200', 'dark:bg-yellow-700', 'text-black', 'dark:text-black');
                            target.classList.remove('text-pink-400', 'text-green-400', 'text-blue-300', 'text-gray-300');
                        }
                    });
                });

                interactiveSqlBlock.addEventListener('mouseleave', () => {
                     explanations.forEach(exp => exp.classList.add('hidden'));
                     hoverTargets.forEach(t => {
                         t.classList.remove('bg-yellow-200', 'dark:bg-yellow-700', 'text-black', 'dark:text-black');
                         if (t.getAttribute('data-hover-target') === 'exp-select' || t.getAttribute('data-hover-target') === 'exp-from' || t.getAttribute('data-hover-target') === 'exp-where') t.classList.add('text-pink-400');
                         if (t.getAttribute('data-hover-target') === 'exp-table') t.classList.add('text-green-400');
                         if (t.getAttribute('data-hover-target') === 'exp-condition') t.classList.add('text-blue-300');
                         if (t.getAttribute('data-hover-target') === 'exp-all') t.classList.add('text-gray-300');
                     });
                     if (defaultExplanation) defaultExplanation.classList.remove('hidden');
                });
            }
        }

        //--- L√ìGICA DEL TEMA (ORIGINAL) ---
        const themeToggle = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            if(lightIcon) lightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            if(darkIcon) darkIcon.classList.remove('hidden');
        }
        if(themeToggle) themeToggle.addEventListener('click', () => {
            if(darkIcon) darkIcon.classList.toggle('hidden');
            if(lightIcon) lightIcon.classList.toggle('hidden');
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

    </script>
</body>

</html>













